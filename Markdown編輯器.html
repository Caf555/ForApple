<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdownç·¨è¼¯å™¨èˆ‡è½‰æª”å·¥å…·</title>
  <!-- å¼•å…¥Markdownè™•ç†ç›¸é—œå‡½å¼åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <style>
    /* åŸºæœ¬æ¨£å¼è¨­å®š */
    :root {
      --paragraph-spacing: 1rem;
      --heading-spacing: 1.5rem;
      --heading-paragraph-spacing: 1rem;
      --content-margin: 2rem;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "å¾®è»Ÿæ­£é»‘é«”", "PingFang TC", "è˜‹æ–¹-ç¹", Arial, sans-serif;
    }
    
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .format-toolbar {
      background-color: #e8e8e8;
      padding: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      border-bottom: 1px solid #ddd;
      align-items: center;
    }
    
    .markdown-toolbar {
      background-color: #f0f0f0;
      padding: 0.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      border-bottom: 1px solid #ddd;
      align-items: center;
    }
    
    .md-btn {
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 3px;
      color: #333;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.3rem 0.5rem;
      min-width: 2rem;
      text-align: center;
      transition: background-color 0.2s, border-color 0.2s;
    }
    
    .md-btn:hover {
      background-color: #f0f0f0;
      border-color: #999;
    }
    
    .separator {
      color: #ccc;
      margin: 0 0.2rem;
    }
    
    .format-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .format-toolbar select {
      padding: 0.3rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      font-size: 0.9rem;
      color: #333;
    }
    
    .format-toolbar label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    header {
      background-color: #1e88e5;
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .toolbar {
      background-color: #f0f0f0;
      padding: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
    
    button, select {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background-color: #2196f3;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #1976d2;
    }
    
    .editor-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .editor-section, .preview-section {
      flex: 1;
      padding: 0;
      overflow: auto;
      position: relative;
    }
    
    .editor-section {
      background-color: #fff;
      border-right: 1px solid #ddd;
    }
    
    #editor {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0;
      padding: var(--content-margin);
      font-family: "Consolas", "Monaco", monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      transition: font-family 0.2s, font-size 0.2s, line-height 0.2s;
      outline: none;
    }
    
          .preview-section {
      background-color: #fff;
    }
    
    #preview {
      padding: var(--content-margin);
      line-height: 1.5;
      font-size: 14px;
      transition: font-family 0.2s, font-size 0.2s, line-height 0.2s, padding 0.2s;
    }
    
    /* ç¢ºä¿é è¦½å…§æ‰€æœ‰å…ƒç´ èƒ½å¤ ç¹¼æ‰¿å­—é«”å±¬æ€§ */
    #preview * {
      font-family: inherit;
    }
    
    /* ç›®éŒ„æ¨£å¼ */
    .table-of-contents {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 2rem;
    }
    
    .table-of-contents h2 {
      margin-top: 0 !important;
      margin-bottom: 1rem !important;
      font-size: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    .table-of-contents ul {
      margin-bottom: 0.5rem;
    }
    
    .table-of-contents ul ul {
      margin-left: 1.5rem;
    }
    
    .table-of-contents a {
      color: #0066cc;
      text-decoration: none;
    }
    
    .table-of-contents a:hover {
      text-decoration: underline;
    }
    
    /* Markdowné è¦½æ¨£å¼ */
    #preview {
      font-family: inherit;
    }
    
    #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
      margin-top: var(--heading-spacing);
      margin-bottom: var(--heading-paragraph-spacing);
      font-weight: 600;
      font-family: inherit;
    }
    
    #preview h1 {
      font-size: 2rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.3rem;
      font-family: inherit;
    }
    
    #preview h2 {
      font-size: 1.75rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.3rem;
      font-family: inherit;
    }
    
    #preview h3 {
      font-size: 1.5rem;
      font-family: inherit;
    }
    
    #preview h4 {
      font-size: 1.25rem;
      font-family: inherit;
    }
    
    #preview p {
      margin-bottom: var(--paragraph-spacing);
      font-family: inherit;
    }
    
    #preview ul, #preview ol {
      margin-bottom: var(--paragraph-spacing);
      padding-left: 2rem;
      font-family: inherit;
    }
    
    #preview li {
      margin-bottom: calc(var(--paragraph-spacing) * 0.5);
      font-family: inherit;
    }
    
    #preview blockquote {
      padding: 0.5rem 1rem;
      margin-bottom: var(--paragraph-spacing);
      border-left: 4px solid #ddd;
      background-color: #f9f9f9;
      font-family: inherit;
    }
    
    #preview code {
      font-family: "Consolas", "Monaco", monospace;
      background-color: #f5f5f5;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.9rem;
    }
    
    #preview pre {
      background-color: #f5f5f5;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 1rem;
    }
    
    #preview pre code {
      background-color: transparent;
      padding: 0;
    }
    
    #preview table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    #preview th, #preview td {
      border: 1px solid #ddd;
      padding: 0.5rem;
    }
    
    #preview th {
      background-color: #f5f5f5;
    }
    
    #preview img {
      max-width: 100%;
      height: auto;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .editor-container {
        flex-direction: column;
      }
      
      .editor-section, .preview-section {
        flex: none;
        height: 50%;
      }
      
      .editor-section {
        border-right: none;
        border-bottom: 1px solid #ddd;
      }
    }
    
    .hidden {
      display: none;
    }
    
    footer {
      background-color: #f0f0f0;
      padding: 0.5rem 1rem;
      text-align: center;
      border-top: 1px solid #ddd;
      font-size: 0.9rem;
      color: #666;
    }
    
    /* åˆ—å°æ¨£å¼ */
    @media print {
      header, .toolbar, .format-toolbar, .markdown-toolbar, .editor-section, footer {
        display: none;
      }
      
      html, body {
        height: auto !important;
        overflow: visible !important;
        background-color: white;
      }
      
      .container {
        display: block;
        height: auto !important;
        overflow: visible !important;
      }
      
      .editor-container {
        display: block;
        height: auto !important;
        overflow: visible !important;
      }
      
      .preview-section {
        display: block;
        width: 100%;
        height: auto !important;
        overflow: visible !important;
        position: static;
      }
      
      #preview {
        padding: 0;
        height: auto !important;
        overflow: visible !important;
        page-break-inside: auto;
      }
      
      /* ç¢ºä¿è¡¨æ ¼ã€åœ–ç‰‡å’Œç¨‹å¼ç¢¼å€å¡Šä¸æœƒè¢«åˆ‡åˆ†åˆ°ä¸åŒé é¢ */
      #preview table, #preview img, #preview pre {
        page-break-inside: avoid;
      }
      
      /* æ¨™é¡Œé¿å…è¢«åˆ†é  */
      #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
        page-break-after: avoid;
      }
      
      /* ä¿è­‰æ®µè½ä¸æœƒè¢«å­¤ç«‹ */
      #preview p {
        widows: 3;
        orphans: 3;
      }
    }
    
    /* è¨­å®šé é¢é‚Šè· */
    @page {
      margin: 2cm;
    }
  </style>
</head>
<body>
  <header>
    <h1>Markdownç·¨è¼¯å™¨èˆ‡è½‰æª”å·¥å…·</h1>
  </header>
  
  <div class="toolbar">
    <button id="new-file" title="æ–°å»ºæª”æ¡ˆ">ğŸ“„</button>
    <button id="open-file" title="é–‹å•Ÿæª”æ¡ˆ">ğŸ“‚</button>
    <input type="file" id="file-input" accept=".md, .markdown, .txt" class="hidden">
    <button id="save-md" title="å„²å­˜ç‚º Markdown">ğŸ’¾ MD</button>
    <button id="save-html" title="è½‰å­˜ç‚º HTML">ğŸ’¾ HTML</button>
    <button id="save-pdf" title="è½‰å­˜ç‚º PDF">ğŸ’¾ PDF</button>
    <button id="print" title="åˆ—å°">ğŸ–¨ï¸</button>
    <button id="generate-toc" title="ç”Ÿæˆç›®éŒ„">ğŸ“‘</button>
  </div>
  
  <div class="markdown-toolbar">
    <button class="md-btn" data-format="heading1" title="ä¸€ç´šæ¨™é¡Œ (# )">H1</button>
    <button class="md-btn" data-format="heading2" title="äºŒç´šæ¨™é¡Œ (## )">H2</button>
    <button class="md-btn" data-format="heading3" title="ä¸‰ç´šæ¨™é¡Œ (### )">H3</button>
    <span class="separator">|</span>
    <button class="md-btn" data-format="bold" title="ç²—é«” (**æ–‡å­—**)"><strong>B</strong></button>
    <button class="md-btn" data-format="italic" title="æ–œé«” (*æ–‡å­—*)"><em>I</em></button>
    <button class="md-btn" data-format="strikethrough" title="åˆªé™¤ç·š (~~æ–‡å­—~~)"><del>S</del></button>
    <span class="separator">|</span>
    <button class="md-btn" data-format="quote" title="å¼•ç”¨ (> )">â</button>
    <button class="md-btn" data-format="code" title="ç¨‹å¼ç¢¼ (`ç¨‹å¼ç¢¼`)">{ }</button>
    <button class="md-btn" data-format="codeblock" title="ç¨‹å¼ç¢¼å€å¡Š (```ç¨‹å¼ç¢¼```)"><small>{ }</small></button>
    <span class="separator">|</span>
    <button class="md-btn" data-format="unorderedList" title="ç„¡åºåˆ—è¡¨ (- )">â€¢</button>
    <button class="md-btn" data-format="orderedList" title="æœ‰åºåˆ—è¡¨ (1. )">1.</button>
    <span class="separator">|</span>
    <button class="md-btn" data-format="link" title="é€£çµ ([æ–‡å­—](ç¶²å€))">ğŸ”—</button>
    <button class="md-btn" data-format="image" title="åœ–ç‰‡ (![æ–‡å­—](åœ–ç‰‡ç¶²å€))">ğŸ–¼ï¸</button>
    <button class="md-btn" data-format="table" title="è¡¨æ ¼">ğŸ“Š</button>
    <button class="md-btn" data-format="horizontalRule" title="æ°´å¹³ç·š (---)">â€•</button>
  </div>
  
  <div class="format-toolbar">
    <div class="format-group">
      <label for="font-selector">å­—é«”ï¼š</label>
      <select id="font-selector">
        <option value="default">é è¨­å­—é«”</option>
        <option value="å¾®è»Ÿæ­£é»‘é«”, Microsoft JhengHei, sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
        <option value="è˜‹æ–¹-ç¹, PingFang TC, sans-serif">è˜‹æ–¹-ç¹</option>
        <option value="æ–°ç´°æ˜é«”, PMingLiU, serif">æ–°ç´°æ˜é«”</option>
        <option value="æ¨™æ¥·é«”, DFKai-SB, sans-serif">æ¨™æ¥·é«”</option>
        <option value="æ€æºé»‘é«”, Noto Sans TC, sans-serif">æ€æºé»‘é«”</option>
        <option value="æ€æºå®‹é«”, Noto Serif TC, serif">æ€æºå®‹é«”</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="Times New Roman, serif">Times New Roman</option>
        <option value="Consolas, Monaco, monospace">ç­‰å¯¬å­—é«”</option>
      </select>
    </div>
    
    <div class="format-group">
      <label for="font-size-selector">å­—è™Ÿï¼š</label>
      <select id="font-size-selector">
        <option value="12px">12px</option>
        <option value="14px" selected>14px</option>
        <option value="16px">16px</option>
        <option value="18px">18px</option>
        <option value="20px">20px</option>
        <option value="24px">24px</option>
      </select>
    </div>
    
    <div class="format-group">
      <label for="line-height-input">è¡Œè·ï¼š</label>
      <input type="number" id="line-height-input" min="1" max="3" step="0.1" value="1.5" style="width: 60px;">
    </div>
    
    <div class="format-group">
      <label for="paragraph-spacing-input">æ®µè·ï¼š</label>
      <input type="number" id="paragraph-spacing-input" min="0.2" max="5" step="0.1" value="1" style="width: 60px;">
      <select id="paragraph-spacing-unit">
        <option value="rem" selected>rem</option>
        <option value="em">em</option>
        <option value="px">px</option>
      </select>
    </div>
    
    <div class="format-group">
      <label for="heading-spacing-input">æ¨™é¡Œé–“è·ï¼š</label>
      <input type="number" id="heading-spacing-input" min="0.5" max="5" step="0.1" value="1.5" style="width: 60px;">
      <select id="heading-spacing-unit">
        <option value="rem" selected>rem</option>
        <option value="em">em</option>
        <option value="px">px</option>
      </select>
    </div>
    
    <div class="format-group">
      <label for="heading-paragraph-spacing-input">æ¨™é¡Œå¾Œé–“è·ï¼š</label>
      <input type="number" id="heading-paragraph-spacing-input" min="0" max="3" step="0.1" value="1" style="width: 60px;">
      <select id="heading-paragraph-spacing-unit">
        <option value="rem" selected>rem</option>
        <option value="em">em</option>
        <option value="px">px</option>
      </select>
    </div>
    
    <div class="format-group">
      <label for="margin-input">é‚Šç•Œï¼š</label>
      <input type="number" id="margin-input" min="0" max="5" step="0.1" value="2" style="width: 60px;">
      <select id="margin-unit">
        <option value="rem" selected>rem</option>
        <option value="em">em</option>
        <option value="px">px</option>
      </select>
    </div>
  </div>
  
  <div class="container">
    <div class="editor-container">
      <div class="editor-section">
        <textarea id="editor" spellcheck="false" placeholder="åœ¨æ­¤è¼¸å…¥Markdownå…§å®¹..."></textarea>
      </div>
      <div class="preview-section">
        <div id="preview"></div>
      </div>
    </div>
  </div>
  
  <footer>
    <p>Â© 2025 Markdownç·¨è¼¯èˆ‡è½‰æª”å·¥å…· | å¯é–‹å•Ÿã€æª¢è¦–ã€ç·¨è¼¯ã€åˆ—å°åŠè½‰æ›Markdownæ–‡ä»¶</p>
  </footer>
  
  <script>
    // éŒ¯èª¤è™•ç†å°è£å‡½æ•¸
    function safeExecute(fn, fallback = () => {}, context = 'operation') {
      try {
        return fn();
      } catch (error) {
        console.error(`åŸ·è¡Œ${context}æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
        return fallback();
      }
    }
    
    // è¨­å®šMarkedé¸é …
    marked.use({
      renderer: new marked.Renderer(),
      highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      },
      langPrefix: 'hljs language-',
      gfm: true,
      breaks: false,
      pedantic: false,
      smartLists: true,
      smartypants: false
    });

    // åˆå§‹åŒ–æª”æ¡ˆåç¨±è®Šæ•¸
    let currentFileName = 'æœªå‘½å';
    
    // ç§»é™¤é›™å‘æ»¾å‹•åŒæ­¥åŠŸèƒ½

    // DOMå…ƒç´ 
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const newFileBtn = document.getElementById('new-file');
    const openFileBtn = document.getElementById('open-file');
    const fileInput = document.getElementById('file-input');
    const saveMdBtn = document.getElementById('save-md');
    const saveHtmlBtn = document.getElementById('save-html');
    const savePdfBtn = document.getElementById('save-pdf');
    const printBtn = document.getElementById('print');
    const generateTocBtn = document.getElementById('generate-toc');
    
    // æ ¼å¼æ§åˆ¶å…ƒç´ 
    const fontSelector = document.getElementById('font-selector');
    const fontSizeSelector = document.getElementById('font-size-selector');
    const lineHeightInput = document.getElementById('line-height-input');
    const paragraphSpacingInput = document.getElementById('paragraph-spacing-input');
    const paragraphSpacingUnit = document.getElementById('paragraph-spacing-unit');
    const headingSpacingInput = document.getElementById('heading-spacing-input');
    const headingSpacingUnit = document.getElementById('heading-spacing-unit');
    const headingParagraphSpacingInput = document.getElementById('heading-paragraph-spacing-input');
    const headingParagraphSpacingUnit = document.getElementById('heading-paragraph-spacing-unit');
    const marginInput = document.getElementById('margin-input');
    const marginUnit = document.getElementById('margin-unit');
    
    // ç¯„ä¾‹Markdownå…§å®¹
    const exampleMarkdown = `# Markdownç·¨è¼¯å™¨ä½¿ç”¨èªªæ˜

## åŸºæœ¬åŠŸèƒ½

é€™æ˜¯ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„Markdownç·¨è¼¯å™¨ï¼Œæ‚¨å¯ä»¥ï¼š

- **å»ºç«‹**æ–°çš„Markdownæ–‡ä»¶
- **é–‹å•Ÿ**ç¾æœ‰çš„Markdownæ–‡ä»¶
- **ç·¨è¼¯**æ–‡ä»¶å…§å®¹
- **é è¦½**æ¸²æŸ“å¾Œçš„æ•ˆæœ
- **å„²å­˜**ç‚ºMarkdownæ ¼å¼
- **è½‰æ›**ç‚ºHTMLæˆ–PDFæ ¼å¼
- **åˆ—å°**æ–‡ä»¶å…§å®¹

## MarkdownåŸºæœ¬èªæ³•

### æ¨™é¡Œ

# ä¸€ç´šæ¨™é¡Œ
## äºŒç´šæ¨™é¡Œ
### ä¸‰ç´šæ¨™é¡Œ

### æ ¼å¼åŒ–æ–‡å­—

**ç²—é«”æ–‡å­—** æˆ– __ç²—é«”æ–‡å­—__

*æ–œé«”æ–‡å­—* æˆ– _æ–œé«”æ–‡å­—_

~~åˆªé™¤ç·š~~

### åˆ—è¡¨

ç„¡åºåˆ—è¡¨ï¼š
- é …ç›®1
- é …ç›®2
  - å­é …ç›®A
  - å­é …ç›®B

æœ‰åºåˆ—è¡¨ï¼š
1. ç¬¬ä¸€é …
2. ç¬¬äºŒé …
3. ç¬¬ä¸‰é …

### é€£çµå’Œåœ–ç‰‡

[é€£çµæ–‡å­—](https://example.com)

![åœ–ç‰‡æ›¿ä»£æ–‡å­—](/api/placeholder/400/200)

### ä»£ç¢¼

è¡Œå…§ä»£ç¢¼ï¼š\`console.log('Hello World');\`

ä»£ç¢¼å€å¡Šï¼š
\`\`\`javascript
function greeting(name) {
  return \`Hello, \${name}!\`;
}
console.log(greeting('World'));
\`\`\`

### è¡¨æ ¼

| æ¬„ä½1 | æ¬„ä½2 | æ¬„ä½3 |
|-------|-------|-------|
| å…§å®¹1 | å…§å®¹2 | å…§å®¹3 |
| å…§å®¹4 | å…§å®¹5 | å…§å®¹6 |

### å¼•ç”¨

> é€™æ˜¯ä¸€æ®µå¼•ç”¨çš„æ–‡å­—ã€‚
> 
> é€™æ˜¯å¼•ç”¨çš„ç¬¬äºŒæ®µè½ã€‚

### æ°´å¹³ç·š

---

## é–‹å§‹ä½¿ç”¨

é–‹å§‹åœ¨å·¦å´ç·¨è¼¯å€åŸŸè¼¸å…¥æ‚¨çš„Markdownå…§å®¹ï¼Œå³å´æœƒå³æ™‚é¡¯ç¤ºé è¦½æ•ˆæœã€‚

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼`;

    // åˆå§‹åŒ–ç·¨è¼¯å™¨
    editor.value = exampleMarkdown;
    updatePreview();
    
    // Markdownè¼”åŠ©å·¥å…·
    const markdownButtons = document.querySelectorAll('.md-btn');
    
    // æ‡‰ç”¨Markdownæ ¼å¼
    function applyMarkdownFormat(format) {
      // ä¿å­˜ç•¶å‰æ»¾å‹•ä½ç½®
      const editorScrollPos = editor.scrollTop;
      
      // ç²å–é¸å–çš„æ–‡å­—
      const selectionStart = editor.selectionStart;
      const selectionEnd = editor.selectionEnd;
      const selectedText = editor.value.substring(selectionStart, selectionEnd);
      const beforeText = editor.value.substring(0, selectionStart);
      const afterText = editor.value.substring(selectionEnd);
      
      let formattedText = '';
      let cursorOffset = 0;
      
      // æ ¹æ“šä¸åŒæ ¼å¼æ‡‰ç”¨ä¸åŒçš„Markdownèªæ³•
      switch (format) {
        case 'heading1':
          formattedText = `# ${selectedText}`;
          cursorOffset = 2;
          break;
        case 'heading2':
          formattedText = `## ${selectedText}`;
          cursorOffset = 3;
          break;
        case 'heading3':
          formattedText = `### ${selectedText}`;
          cursorOffset = 4;
          break;
        case 'bold':
          formattedText = `**${selectedText}**`;
          cursorOffset = 2;
          break;
        case 'italic':
          formattedText = `*${selectedText}*`;
          cursorOffset = 1;
          break;
        case 'strikethrough':
          formattedText = `~~${selectedText}~~`;
          cursorOffset = 2;
          break;
        case 'quote':
          formattedText = `> ${selectedText}`;
          cursorOffset = 2;
          break;
        case 'code':
          formattedText = `\`${selectedText}\``;
          cursorOffset = 1;
          break;
        case 'codeblock':
          formattedText = `\`\`\`\n${selectedText}\n\`\`\``;
          cursorOffset = 4;
          break;
        case 'unorderedList':
          // è™•ç†å¤šè¡Œæ–‡æœ¬
          if (selectedText.indexOf('\n') !== -1) {
            formattedText = selectedText.split('\n').map(line => `- ${line}`).join('\n');
          } else {
            formattedText = `- ${selectedText}`;
          }
          cursorOffset = 2;
          break;
        case 'orderedList':
          // è™•ç†å¤šè¡Œæ–‡æœ¬
          if (selectedText.indexOf('\n') !== -1) {
            const lines = selectedText.split('\n');
            formattedText = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
          } else {
            formattedText = `1. ${selectedText}`;
          }
          cursorOffset = 3;
          break;
        case 'link':
          if (selectedText) {
            formattedText = `[${selectedText}](ç¶²å€)`;
            cursorOffset = selectedText.length + 3;
          } else {
            formattedText = `[é€£çµæ–‡å­—](ç¶²å€)`;
            cursorOffset = 1; // å°‡æ¸¸æ¨™æ”¾åœ¨é€£çµæ–‡å­—ä¸­
          }
          break;
        case 'image':
          formattedText = `![${selectedText || 'åœ–ç‰‡æè¿°'}](åœ–ç‰‡ç¶²å€)`;
          cursorOffset = selectedText ? selectedText.length + 3 : 4;
          break;
        case 'table':
          formattedText = `| æ¬„ä½1 | æ¬„ä½2 | æ¬„ä½3 |\n|--------|--------|--------|\n| å…§å®¹1 | å…§å®¹2 | å…§å®¹3 |\n| å…§å®¹4 | å…§å®¹5 | å…§å®¹6 |`;
          cursorOffset = 0;
          break;
        case 'horizontalRule':
          formattedText = `\n---\n`;
          cursorOffset = 0;
          break;
        default:
          formattedText = selectedText;
      }
      
      // æ›´æ–°ç·¨è¼¯å™¨å…§å®¹
      editor.value = beforeText + formattedText + afterText;
      
      // æ›´æ–°é è¦½
      updatePreview();
      
      // è¨­ç½®æ–°çš„æ¸¸æ¨™ä½ç½®
      if (selectionStart === selectionEnd) {
        // å¦‚æœæ²’æœ‰é¸å–æ–‡å­—ï¼Œå°‡æ¸¸æ¨™æ”¾åœ¨æ’å…¥çš„æ ¼å¼ä¸­é–“æˆ–çµå°¾
        const newPosition = selectionStart + formattedText.length - (format === 'link' || format === 'image' ? cursorOffset : 0);
        editor.setSelectionRange(newPosition, newPosition);
      } else {
        // å¦‚æœæœ‰é¸å–æ–‡å­—ï¼Œå°‡é¸æ“‡ç¯„åœä¿æŒåœ¨æ ¼å¼åŒ–å¾Œçš„æ–‡å­—ä¸Š
        const newSelectionStart = selectionStart;
        const newSelectionEnd = selectionStart + formattedText.length;
        editor.setSelectionRange(newSelectionStart, newSelectionEnd);
      }
      
      // è®“ç·¨è¼¯å™¨é‡æ–°ç²å¾—ç„¦é»
      editor.focus();
      
      // æ¢å¾©æ»¾å‹•ä½ç½®
      if (editor.scrollTop !== editorScrollPos) {
        editor.scrollTop = editorScrollPos;
      }
    }
    
    // ç‚ºæ¯å€‹Markdownæ ¼å¼æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½
    markdownButtons.forEach(button => {
      button.addEventListener('click', () => {
        const format = button.getAttribute('data-format');
        applyMarkdownFormat(format);
      });
    });
    
    // ç”Ÿæˆç›®éŒ„
    generateTocBtn.addEventListener('click', () => {
      // ä¿å­˜ç•¶å‰æ»¾å‹•ä½ç½®
      const editorScrollPos = editor.scrollTop;
      
      // è§£æå…§å®¹ä¸­çš„æ¨™é¡Œ
      const content = editor.value;
      const headingRegex = /^(#{1,6})\s+(.+)$/gm;
      const headings = [];
      let match;
      
      while ((match = headingRegex.exec(content)) !== null) {
        const level = match[1].length;
        const text = match[2].trim();
        const slug = text.toLowerCase()
          .replace(/[^\w\u4e00-\u9fa5\- ]/g, '') // å…è¨±ä¸­æ–‡å­—ç¬¦
          .replace(/\s+/g, '-');
        
        headings.push({ level, text, slug });
      }
      
      // å¦‚æœæ‰¾ä¸åˆ°æ¨™é¡Œï¼Œæç¤ºç”¨æˆ¶
      if (headings.length === 0) {
        alert('æœªæ‰¾åˆ°æ¨™é¡Œï¼è«‹å…ˆæ·»åŠ ä¸€äº›æ¨™é¡Œï¼ˆ# é–‹é ­çš„æ–‡å­—è¡Œï¼‰ã€‚');
        return;
      }
      
      // ç”Ÿæˆç›®éŒ„HTML
      let tocHtml = '<div class="table-of-contents">\n';
      tocHtml += '<h2>ç›®éŒ„</h2>\n';
      tocHtml += '<ul>\n';
      
      const minLevel = Math.min(...headings.map(h => h.level));
      let currentLevel = minLevel;
      
      headings.forEach((heading, index) => {
        while (currentLevel < heading.level) {
          tocHtml += '<ul>\n';
          currentLevel++;
        }
        
        while (currentLevel > heading.level) {
          tocHtml += '</ul>\n';
          currentLevel--;
        }
        
        tocHtml += `<li><a href="#${heading.slug}">${heading.text}</a></li>\n`;
      });
      
      while (currentLevel > minLevel) {
        tocHtml += '</ul>\n';
        currentLevel--;
      }
      
      tocHtml += '</ul>\n';
      tocHtml += '</div>\n\n';
      
      // æ’å…¥ç›®éŒ„åˆ°ç·¨è¼¯å™¨é ‚éƒ¨
      editor.value = tocHtml + editor.value;
      
      // æ›´æ–°é è¦½ä¸¦æ·»åŠ IDåˆ°æ¨™é¡Œå…ƒç´ ä»¥æ”¯æŒéŒ¨é»è·³è½‰
      updatePreview();
      
      // ä½¿ç·¨è¼¯å™¨å’Œé è¦½å€åŸŸæ»¾å‹•åˆ°é ‚éƒ¨
      editor.scrollTop = 0;
      preview.scrollTop = 0;
    });
    
    // é›™å‘åŒæ­¥æ»¾å‹•
    
    editor.addEventListener('scroll', function() {
      // å¦‚æœæ˜¯é è¦½å€åŸŸå¼•èµ·çš„æ»¾å‹•ï¼Œå‰‡ä¸åšè™•ç†é¿å…å¾ªç’°
      if (isPreviewScrolling) return;
      
      // æ¨™è¨˜ç‚ºç·¨è¼¯å™¨æ»¾å‹•ä¸­
      isEditorScrolling = true;
      
      // æª¢æŸ¥ç·¨è¼¯å™¨æ˜¯å¦éœ€è¦æ»¾å‹•
      if (editor.scrollHeight <= editor.clientHeight) {
        isEditorScrolling = false;
        return;
      }
      
      // è¨ˆç®—æ»¾å‹•ç™¾åˆ†æ¯”
      const scrollPercentage = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
      
      // æª¢æŸ¥é è¦½å€æ˜¯å¦éœ€è¦æ»¾å‹•
      if (preview.scrollHeight > preview.clientHeight) {
        // æ‡‰ç”¨åˆ°é è¦½å€åŸŸ
        preview.scrollTop = scrollPercentage * (preview.scrollHeight - preview.clientHeight);
      }
      
      // é˜²æ­¢ç„¡é™å¾ªç’°
      setTimeout(() => {
        isEditorScrolling = false;
      }, 50);
    });
    
    preview.addEventListener('scroll', function() {
      // å¦‚æœæ˜¯ç·¨è¼¯å™¨å¼•èµ·çš„æ»¾å‹•ï¼Œå‰‡ä¸åšè™•ç†é¿å…å¾ªç’°
      if (isEditorScrolling) return;
      
      // æ¨™è¨˜ç‚ºé è¦½å€åŸŸæ»¾å‹•ä¸­
      isPreviewScrolling = true;
      
      // æª¢æŸ¥é è¦½å€æ˜¯å¦éœ€è¦æ»¾å‹•
      if (preview.scrollHeight <= preview.clientHeight) {
        isPreviewScrolling = false;
        return;
      }
      
      // è¨ˆç®—æ»¾å‹•ç™¾åˆ†æ¯”
      const scrollPercentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);
      
      // æª¢æŸ¥ç·¨è¼¯å™¨æ˜¯å¦éœ€è¦æ»¾å‹•
      if (editor.scrollHeight > editor.clientHeight) {
        // æ‡‰ç”¨åˆ°ç·¨è¼¯å™¨
        editor.scrollTop = scrollPercentage * (editor.scrollHeight - editor.clientHeight);
      }
      
      // é˜²æ­¢ç„¡é™å¾ªç’°
      setTimeout(() => {
        isPreviewScrolling = false;
      }, 50);
    });
    
    // ç§»é™¤æ»¾å‹•åŒæ­¥åŠŸèƒ½ï¼Œåªä¿ç•™é è¦½æ›´æ–°
    function updatePreview() {
      // è™•ç†Markdownå…§å®¹
      const markdown = editor.value;
      const html = marked.parse(markdown);
      
      // æ›´æ–°é è¦½å…§å®¹
      preview.innerHTML = html;
      
      // ç‚ºæ¨™é¡Œæ·»åŠ IDä»¥æ”¯æŒéŒ¨é»è·³è½‰
      const headers = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headers.forEach(header => {
        if (!header.id) {
          const slug = header.textContent.toLowerCase()
            .replace(/[^\w\u4e00-\u9fa5\- ]/g, '')
            .replace(/\s+/g, '-');
          header.id = slug;
        }
      });
      
      // è™•ç†ç›®éŒ„å…§çš„éŒ¨é»é€£çµ
      const tocLinks = preview.querySelectorAll('.table-of-contents a');
      tocLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    }
    
    // äº‹ä»¶ç›£è½
    editor.addEventListener('input', updatePreview);
    
    // æ–°å»ºæª”æ¡ˆ
    newFileBtn.addEventListener('click', () => {
      if (editor.value && !confirm('ç¢ºå®šè¦æ–°å»ºæª”æ¡ˆå—ï¼Ÿæœªå„²å­˜çš„å…§å®¹å°‡æœƒéºå¤±ã€‚')) {
        return;
      }
      editor.value = '';
      updatePreview();
      currentFileName = 'æœªå‘½å';
      
      // é‡ç½®æ»¾å‹•ä½ç½®
      editor.scrollTop = 0;
      preview.scrollTop = 0;
    });
    
    // é–‹å•Ÿæª”æ¡ˆ
    openFileBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        editor.value = event.target.result;
        updatePreview();
        currentFileName = file.name.replace(/\.[^/.]+$/, ""); // ç§»é™¤å‰¯æª”å
        
        // é‡ç½®æ»¾å‹•ä½ç½®
        editor.scrollTop = 0;
        preview.scrollTop = 0;
      };
      reader.readAsText(file);
      
      // é‡è¨­inputï¼Œä»¥ä¾¿ä¸‹æ¬¡é¸æ“‡ç›¸åŒæª”æ¡ˆæ™‚ä¹Ÿèƒ½è§¸ç™¼changeäº‹ä»¶
      fileInput.value = '';
    });
    
    // å„²å­˜ç‚ºMarkdown
    saveMdBtn.addEventListener('click', () => {
      const blob = new Blob([editor.value], { type: 'text/markdown;charset=utf-8' });
      saveAs(blob, `${currentFileName}.md`);
    });
    
    // è½‰å­˜ç‚ºHTML
    saveHtmlBtn.addEventListener('click', () => {
      // å–å¾—ç•¶å‰å­—é«”è¨­å®š
      const fontFamily = fontSelector.value === 'default' 
        ? '"å¾®è»Ÿæ­£é»‘é«”", "PingFang TC", "è˜‹æ–¹-ç¹", Arial, sans-serif' 
        : fontSelector.value;
      const fontSize = fontSizeSelector.value;
      const lineHeight = lineHeightInput.value;
      
      const paragraphSpacing = `${paragraphSpacingInput.value}${paragraphSpacingUnit.value}`;
      const headingSpacing = `${headingSpacingInput.value}${headingSpacingUnit.value}`;
      const headingParagraphSpacing = `${headingParagraphSpacingInput.value}${headingParagraphSpacingUnit.value}`;
      const contentMargin = `${marginInput.value}${marginUnit.value}`;
      
      // å»ºç«‹ä¸€å€‹åŸºæœ¬çš„HTMLæ–‡ä»¶çµæ§‹
      const htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${currentFileName}</title>
  <style>
    body {
      font-family: ${fontFamily};
      font-size: ${fontSize};
      line-height: ${lineHeight};
      max-width: 800px;
      margin: 0 auto;
      padding: ${contentMargin};
      color: #333;
    }
    p {
      margin-bottom: ${paragraphSpacing};
    }
    ul, ol {
      margin-bottom: ${paragraphSpacing};
      padding-left: 2rem;
    }
    li {
      margin-bottom: calc(${paragraphSpacing} * 0.5);
    }
    blockquote {
      margin-bottom: ${paragraphSpacing};
      padding-left: 16px;
      border-left: 4px solid #ddd;
      color: #666;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: ${headingSpacing};
      margin-bottom: ${headingParagraphSpacing};
      font-weight: 600;
    }
    pre {
      background-color: #f5f5f5;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
    }
    code {
      font-family: Consolas, Monaco, monospace;
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
    }
    pre code {
      background-color: transparent;
      padding: 0;
    }
    blockquote {
      border-left: 4px solid #ddd;
      padding-left: 16px;
      margin-left: 0;
      color: #666;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px 12px;
    }
    img {
      max-width: 100%;
    }
  </style>
</head>
<body>
  ${preview.innerHTML}
</body>
</html>`;
      
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      saveAs(blob, `${currentFileName}.html`);
    });
    
    // è½‰å­˜ç‚ºPDF
    savePdfBtn.addEventListener('click', () => {
      try {
        // å‰µå»ºä¸€å€‹è‡¨æ™‚å®¹å™¨ç”¨æ–¼ç”ŸæˆPDF
        const container = document.createElement('div');
        container.innerHTML = preview.innerHTML;
        container.style.width = '210mm';
        container.style.padding = '15mm';
        container.style.backgroundColor = 'white';
        
        // æ‡‰ç”¨ç•¶å‰æ–‡å­—æ ¼å¼è¨­å®š
        const fontFamily = fontSelector.value;
        if (fontFamily !== 'default') {
          container.style.fontFamily = fontFamily;
        } else {
          container.style.fontFamily = '"å¾®è»Ÿæ­£é»‘é«”", "PingFang TC", "è˜‹æ–¹-ç¹", Arial, sans-serif';
        }
        
        container.style.fontSize = fontSizeSelector.value;
        container.style.lineHeight = lineHeightInput.value;
        
        const paragraphSpacing = `${paragraphSpacingInput.value}${paragraphSpacingUnit.value}`;
        const headingSpacing = `${headingSpacingInput.value}${headingSpacingUnit.value}`;
        const headingParagraphSpacing = `${headingParagraphSpacingInput.value}${headingParagraphSpacingUnit.value}`;
        
        // æ‡‰ç”¨æ®µè½é–“è·
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          p { margin-bottom: ${paragraphSpacing}; }
          ul, ol { margin-bottom: ${paragraphSpacing}; }
          li { margin-bottom: calc(${paragraphSpacing} * 0.5); }
          blockquote { margin-bottom: ${paragraphSpacing}; }
          h1, h2, h3, h4, h5, h6 { 
            margin-top: ${headingSpacing}; 
            margin-bottom: ${headingParagraphSpacing};
          }
        `;
        container.appendChild(styleElement);
        container.style.visibility = 'hidden';
        container.style.position = 'absolute';
        container.style.top = '0';
        container.style.left = '0';
        container.style.zIndex = '-9999';
        document.body.appendChild(container);
        
        // ä½¿ç”¨html2pdfåº«ç”ŸæˆPDFï¼Œå¢å¼·å¤šé æ”¯æ´
        const opt = {
          margin: [15, 15, 15, 15],
          filename: `${currentFileName}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            logging: false,
            windowHeight: container.scrollHeight + 200
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            hotfixes: ["px_scaling"]
          },
          pagebreak: { 
            mode: ['avoid-all', 'css', 'legacy'],
            avoid: ['tr', 'img', 'table', 'pre']
          }
        };
        
        // é¡¯ç¤ºè™•ç†æç¤º
        const processingMsg = document.createElement('div');
        processingMsg.textContent = 'æ­£åœ¨è™•ç†PDFï¼Œè«‹ç¨å€™...';
        processingMsg.style.position = 'fixed';
        processingMsg.style.top = '50%';
        processingMsg.style.left = '50%';
        processingMsg.style.transform = 'translate(-50%, -50%)';
        processingMsg.style.padding = '15px 20px';
        processingMsg.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        processingMsg.style.color = 'white';
        processingMsg.style.borderRadius = '5px';
        processingMsg.style.zIndex = '9999';
        document.body.appendChild(processingMsg);
        
        html2pdf().set(opt).from(container).save().then(() => {
          try {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
            if (document.body.contains(processingMsg)) {
              document.body.removeChild(processingMsg);
            }
          } catch (cleanupError) {
            console.error('æ¸…ç†PDFç”Ÿæˆè³‡æºæ™‚ç™¼ç”ŸéŒ¯èª¤:', cleanupError);
          }
        }).catch(err => {
          console.error('PDFç”ŸæˆéŒ¯èª¤:', err);
          try {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
            if (document.body.contains(processingMsg)) {
              document.body.removeChild(processingMsg);
            }
          } catch (cleanupError) {
            console.error('æ¸…ç†PDFç”Ÿæˆè³‡æºæ™‚ç™¼ç”ŸéŒ¯èª¤:', cleanupError);
          }
          alert('PDFç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„å…§å®¹æˆ–å˜—è©¦æ¸›å°‘é é¢è¤‡é›œåº¦ã€‚');
        });
      } catch (error) {
        console.error('PDFç”Ÿæˆæº–å‚™éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('PDFç”Ÿæˆå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
      }
    });
    
    // åˆ—å°
    printBtn.addEventListener('click', () => {
      try {
        // å‰µå»ºä¸€å€‹å°ˆé–€ç”¨æ–¼åˆ—å°çš„å…§å®¹å®¹å™¨
        const printContent = document.createElement('div');
        printContent.innerHTML = preview.innerHTML;
        printContent.id = 'print-container';
        
        // å¥—ç”¨ç•¶å‰çš„å­—é«”è¨­å®šåˆ°åˆ—å°å®¹å™¨
        const fontFamily = fontSelector.value;
        const fontSize = fontSizeSelector.value;
        const lineHeight = lineHeightInput.value;
        
        const paragraphSpacing = `${paragraphSpacingInput.value}${paragraphSpacingUnit.value}`;
        const headingSpacing = `${headingSpacingInput.value}${headingSpacingUnit.value}`;
        const headingParagraphSpacing = `${headingParagraphSpacingInput.value}${headingParagraphSpacingUnit.value}`;
        
        if (fontFamily !== 'default') {
          printContent.style.fontFamily = fontFamily;
        } else {
          printContent.style.fontFamily = '"å¾®è»Ÿæ­£é»‘é«”", "PingFang TC", "è˜‹æ–¹-ç¹", Arial, sans-serif';
        }
        
        printContent.style.fontSize = fontSize;
        printContent.style.lineHeight = lineHeight;
        
        // æ‡‰ç”¨æ®µè½é–“è·
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          #print-container p { margin-bottom: ${paragraphSpacing}; }
          #print-container ul, #print-container ol { margin-bottom: ${paragraphSpacing}; }
          #print-container li { margin-bottom: calc(${paragraphSpacing} * 0.5); }
          #print-container blockquote { margin-bottom: ${paragraphSpacing}; }
          #print-container h1, #print-container h2, #print-container h3, 
          #print-container h4, #print-container h5, #print-container h6 { 
            margin-top: ${headingSpacing}; 
            margin-bottom: ${headingParagraphSpacing};
          }
        `;
        document.head.appendChild(styleElement);
        
        printContent.style.display = 'none';
        printContent.style.width = '100%';
        printContent.style.height = 'auto';
        printContent.style.position = 'absolute';
        printContent.style.left = '0';
        printContent.style.top = '0';
        printContent.style.zIndex = '-1';
        document.body.appendChild(printContent);
        
        // ä½¿ç”¨å»¶é²ç¢ºä¿å…§å®¹å·²æº–å‚™å¥½
        setTimeout(() => {
          window.print();
          
          // åˆ—å°å®Œæˆå¾Œç§»é™¤è‡¨æ™‚å®¹å™¨
          setTimeout(() => {
            try {
              if (document.body.contains(printContent)) {
                document.body.removeChild(printContent);
              }
              if (document.head.contains(styleElement)) {
                document.head.removeChild(styleElement);
              }
            } catch (cleanupError) {
              console.error('æ¸…ç†åˆ—å°è³‡æºæ™‚ç™¼ç”ŸéŒ¯èª¤:', cleanupError);
            }
          }, 1000);
        }, 300);
      } catch (error) {
        console.error('åˆ—å°æº–å‚™éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('åˆ—å°æº–å‚™å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
      }
    });
    
    // è¨­å®šMarkedé¸é …ï¼Œä½¿ç”¨é»˜èªä¸»é¡Œ
    marked.use({
      renderer: new marked.Renderer(),
      highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      },
      langPrefix: 'hljs language-',
      gfm: true,
      breaks: false,
      pedantic: false,
      smartLists: true,
      smartypants: false
    });
    
    // æ›´æ–°ç·¨è¼¯å™¨å’Œé è¦½å€åŸŸçš„å­—é«”è¨­å®š
    function updateTextFormatting() {
      const fontFamily = fontSelector.value;
      const fontSize = fontSizeSelector.value;
      const lineHeight = lineHeightInput.value;
      
      const paragraphSpacing = `${paragraphSpacingInput.value}${paragraphSpacingUnit.value}`;
      const headingSpacing = `${headingSpacingInput.value}${headingSpacingUnit.value}`;
      const headingParagraphSpacing = `${headingParagraphSpacingInput.value}${headingParagraphSpacingUnit.value}`;
      const contentMargin = `${marginInput.value}${marginUnit.value}`;
      
      // è‹¥é¸æ“‡é è¨­å­—é«”ï¼Œå‰‡ä½¿ç”¨é è¨­è¨­å®š
      if (fontFamily === 'default') {
        editor.style.fontFamily = '"Consolas", "Monaco", monospace';
        preview.style.fontFamily = '"å¾®è»Ÿæ­£é»‘é«”", "PingFang TC", "è˜‹æ–¹-ç¹", Arial, sans-serif';
      } else {
        editor.style.fontFamily = fontFamily;
        preview.style.fontFamily = fontFamily;
      }
      
      // æ‡‰ç”¨å­—è™Ÿå’Œè¡Œè·
      editor.style.fontSize = fontSize;
      editor.style.lineHeight = lineHeight;
      preview.style.fontSize = fontSize;
      preview.style.lineHeight = lineHeight;
      
      // æ‡‰ç”¨æ®µè½é–“è·ã€æ¨™é¡Œé–“è·å’Œé‚Šç•Œ
      document.documentElement.style.setProperty('--paragraph-spacing', paragraphSpacing);
      document.documentElement.style.setProperty('--heading-spacing', headingSpacing);
      document.documentElement.style.setProperty('--heading-paragraph-spacing', headingParagraphSpacing);
      document.documentElement.style.setProperty('--content-margin', contentMargin);
      
      // å¼·åˆ¶è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿å­—é«”å¥—ç”¨åˆ°æ‰€æœ‰é è¦½å…ƒç´ 
      updatePreview();
    }
    
    // ç›£è½å­—é«”è¨­å®šè®Šæ›´
    fontSelector.addEventListener('change', updateTextFormatting);
    fontSizeSelector.addEventListener('change', updateTextFormatting);
    
    lineHeightInput.addEventListener('input', updateTextFormatting);
    
    paragraphSpacingInput.addEventListener('input', updateTextFormatting);
    paragraphSpacingUnit.addEventListener('change', updateTextFormatting);
    
    headingSpacingInput.addEventListener('input', updateTextFormatting);
    headingSpacingUnit.addEventListener('change', updateTextFormatting);
    
    headingParagraphSpacingInput.addEventListener('input', updateTextFormatting);
    headingParagraphSpacingUnit.addEventListener('change', updateTextFormatting);
    
    marginInput.addEventListener('input', updateTextFormatting);
    marginUnit.addEventListener('change', updateTextFormatting);
    
    // åˆå§‹åŒ–ç·¨è¼¯å™¨å…§å®¹
    window.addEventListener('DOMContentLoaded', function() {
      // è¨­ç½®åˆå§‹å…§å®¹
      editor.value = exampleMarkdown;
      
      // æ›´æ–°é è¦½
      try {
        updatePreview();
      } catch (error) {
        console.error('åˆå§‹åŒ–é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
      
      // åˆå§‹æ‡‰ç”¨é è¨­è¨­å®š
      try {
        updateTextFormatting();
      } catch (error) {
        console.error('å¥—ç”¨æ–‡å­—æ ¼å¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è¨­å®š:', error);
      }
      
      // ç¢ºä¿åˆå§‹æ»¾å‹•ä½ç½®ç‚ºé ‚éƒ¨
      editor.scrollTop = 0;
      preview.scrollTop = 0;
      
      console.log('Markdownç·¨è¼¯å™¨å·²æˆåŠŸåˆå§‹åŒ–');
    });
    
    // è‡ªå‹•èª¿æ•´ç·¨è¼¯å™¨å¤§å° - ç§»é™¤é€™å€‹åŠŸèƒ½ï¼Œå› ç‚ºå®ƒæœƒå½±éŸ¿ç·¨è¼¯é«”é©—
    // åœ¨é€™å€‹è¨­è¨ˆä¸­ï¼Œç·¨è¼¯å™¨æ‡‰è©²ä½¿ç”¨å…¨é«˜åº¦ä½ˆå±€ï¼Œä¸éœ€è¦è‡ªå‹•èª¿æ•´é«˜åº¦
    // function adjustEditorHeight() {
    //   editor.style.height = 'auto';
    //   editor.style.height = editor.scrollHeight + 'px';
    // }
    
    // åˆå§‹èª¿æ•´
    // window.addEventListener('load', adjustEditorHeight);
    // window.addEventListener('resize', adjustEditorHeight);
    
    // é˜²æ­¢é—œé–‰é é¢æ™‚éºå¤±ç·¨è¼¯ä¸­çš„å…§å®¹
    window.addEventListener('beforeunload', (e) => {
      if (editor.value) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
    
    // æ‹–æ”¾æª”æ¡ˆåŠŸèƒ½
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.body.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });
    
    document.body.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown') || file.name.endsWith('.txt'))) {
        const reader = new FileReader();
        reader.onload = (event) => {
          editor.value = event.target.result;
          updatePreview();
          currentFileName = file.name.replace(/\.[^/.]+$/, "");
          
          // é‡ç½®æ»¾å‹•ä½ç½®
          editor.scrollTop = 0;
          preview.scrollTop = 0;
        };
        reader.readAsText(file);
      }
    }, false);
  </script>
</body>
</html>
