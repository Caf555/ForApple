<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Commons ÁÖßÁâáÈÄ£ÁµêÊî∂ÈõÜÂ∑•ÂÖ∑</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --accent-color: #9b59b6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }
        
        .tab.active {
            border-bottom-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .note {
            background-color: #fdf2e9;
            border-left: 4px solid var(--warning-color);
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .search-section {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .button-primary {
            background-color: var(--primary-color);
        }
        
        .button-primary:hover {
            background-color: #1e2b38;
        }
        
        .button-success {
            background-color: var(--success-color);
        }
        
        .button-success:hover {
            background-color: #219653;
        }
        
        .button-danger {
            background-color: var(--danger-color);
        }
        
        .button-danger:hover {
            background-color: #c0392b;
        }
        
        .button-accent {
            background-color: var(--accent-color);
        }
        
        .button-accent:hover {
            background-color: #8e44ad;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .search-results, .saved-links {
            flex: 1;
            min-width: 300px;
        }
        
        .section-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title .actions {
            display: flex;
            gap: 10px;
        }
        
        .section-title .actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-card {
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .photo-image-container {
            position: relative;
            width: 100%;
            height: 180px;
            overflow: hidden;
            background-color: #f6f6f6;
        }
        
        .photo-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: move;
        }
        
        .drag-instruction {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            font-size: 11px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .photo-image-container:hover .drag-instruction {
            opacity: 1;
        }
        
        .photo-details {
            padding: 10px;
        }
        
        .photo-title {
            font-size: 14px;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 42px;
        }
        
        .photo-links {
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .photo-link {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .link-content {
            font-size: 12px;
            color: var(--secondary-color);
            word-break: break-all;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .link-label {
            display: inline-block;
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 5px;
            font-weight: bold;
            min-width: 48px;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-left: 5px;
        }
        
        .icon-button {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            transition: background-color 0.2s;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-button:hover {
            background-color: #bdc3c7;
        }
        
        .copy-icon::before {
            content: "üìã";
        }
        
        .open-icon::before {
            content: "üîó";
        }
        
        .photo-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .photo-button {
            padding: 6px 12px;
            font-size: 12px;
            flex: 1;
        }
        
        .saved-links-list {
            border: 1px solid #eee;
            border-radius: 4px;
            margin-top: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .saved-link-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .saved-link-item:last-child {
            border-bottom: none;
        }
        
        .saved-link-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .saved-link-keyword {
            font-size: 12px;
            color: var(--accent-color);
            font-weight: normal;
            background-color: #f5f0ff;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .saved-link-url {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            word-break: break-all;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .saved-link-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .saved-link-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .saved-link-thumb {
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            background-color: #f6f6f6;
            margin-bottom: 5px;
        }
        
        .export-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .export-section button {
            padding: 8px 15px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .saved-links-empty {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .file-import {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #ddd;
        }
        
        .search-options {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-option label {
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            position: relative;
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--dark-color);
        }
        
        .modal-image-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            max-height: 70vh;
            overflow: auto;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        
        .modal-links {
            margin-top: 20px;
        }
        
        .modal-link-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
        }
        
        .modal-link-text {
            flex: 1;
            font-size: 14px;
            word-break: break-all;
            margin-left: 10px;
        }
        
        .batch-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .batch-textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        
        .batch-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .batch-status {
            margin-top: 10px;
            padding: 15px;
            border-radius: 4px;
            background-color: var(--light-color);
            display: none;
        }
        
        .batch-progress {
            margin-top: 10px;
            height: 20px;
            border-radius: 10px;
            background-color: #ddd;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .batch-results {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .batch-result-item {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .batch-result-item:last-child {
            border-bottom: none;
        }
        
        .batch-keyword {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .batch-links {
            margin-top: 10px;
        }
        
        .batch-link {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .batch-link:last-child {
            border-bottom: none;
        }
        
        .batch-link-title {
            flex: 1;
            font-size: 13px;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .batch-link-url {
            color: var(--secondary-color);
            font-size: 12px;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .export-preview {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow: auto;
        }
        
        .export-preview pre {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .results-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .batch-controls {
                flex-direction: column;
            }
            
            .file-import {
                flex-direction: column;
            }
            
            .export-section {
                flex-direction: column;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }
            
            .tab {
                flex: 0 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wikimedia Commons ÁÖßÁâáÈÄ£ÁµêÊî∂ÈõÜÂ∑•ÂÖ∑</h1>
            <p class="description">ÊêúÂ∞ã„ÄÅÈÅ∏Êìá‰∏¶ÂÑ≤Â≠ò Wikimedia Commons ÁÖßÁâáÁöÑÂØ¶ÈöõÈÄ£Áµê</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="search-tab">ÂñÆ‰∏ÄÊêúÂ∞ã</div>
            <div class="tab" data-tab="batch-tab">ÊâπÊ¨°Êü•Ë©¢</div>
            <div class="tab" data-tab="saved-tab">Â∑≤ÂÑ≤Â≠òÈÄ£Áµê</div>
            <div class="tab" data-tab="export-tab">ÂåØÂá∫Ë≥áÊñô</div>
        </div>
        
        <div class="note">
            <p><strong>Ë™™ÊòéÔºö</strong>Êú¨Â∑•ÂÖ∑ÂèØÁç≤ÂèñÁÖßÁâáÁöÑÂØ¶ÈöõÁõ¥Êé•ÈÄ£ÁµêÔºàÂ¶ÇÔºöhttps://upload.wikimedia.org/wikipedia/commons/2/21/‰∏ÉÊòüÂ±±Âà∞Â∞èÊ≤πÂùëÊ≠•ÈÅì.jpgÔºâ„ÄÇÂ¶ÇÊûúÈÄ£ÁµêÁÑ°Ê≥ïËá™ÂãïÂèñÂæóÔºåÊÇ®ÂèØ‰ª•ÊãñÊõ≥ÂúñÁâáÊü•Áúã‰∏¶Áç≤ÂèñÈÄ£Áµê„ÄÇË´ãÂú®ÊØèÊ¨°‰ΩøÁî®ÂæåÔºå‰ΩøÁî®„ÄåÂåØÂá∫„ÄçÂäüËÉΩ‰øùÂ≠òÊÇ®Êî∂ÈõÜÁöÑÈÄ£Áµê„ÄÇ</p>
        </div>
        
        <!-- ÂñÆ‰∏ÄÊêúÂ∞ãÊ®ôÁ±§È†Å -->
        <div id="search-tab" class="tab-content active">
            <section class="search-section">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Ë´ãËº∏ÂÖ•ÊêúÂ∞ãÈóúÈçµÂ≠ó...">
                    <button id="search-button" class="button-primary">ÊêúÂ∞ã</button>
                </div>
                <div class="search-options">
                    <div class="search-option">
                        <input type="number" id="limit-input" min="5" max="50" value="20" style="width: 60px;">
                        <label for="limit-input">ÁµêÊûúÊï∏Èáè</label>
                    </div>
                </div>
            </section>
            
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Ê≠£Âú®ÊêúÂ∞ã‰∏¶Áç≤ÂèñÁÖßÁâáÈÄ£Áµê...</p>
            </div>
            
            <div class="search-results">
                <h2 class="section-title">
                    <span>ÊêúÂ∞ãÁµêÊûú</span>
                    <div class="actions">
                        <button id="save-top-5" class="button-accent">ÂÑ≤Â≠òÂâç 5 Á≠Ü</button>
                    </div>
                </h2>
                <div id="results-container" class="results-container">
                    <div class="no-results">Ë´ãËº∏ÂÖ•ÈóúÈçµÂ≠óÈñãÂßãÊêúÂ∞ã</div>
                </div>
            </div>
        </div>
        
        <!-- ÊâπÊ¨°Êü•Ë©¢Ê®ôÁ±§È†Å -->
        <div id="batch-tab" class="tab-content">
            <div class="batch-section">
                <h2 class="section-title">ÊâπÊ¨°Êü•Ë©¢Ë®≠ÂÆö</h2>
                <p>Ë´ãËº∏ÂÖ•Â§öÂÄãÊü•Ë©¢ÈóúÈçµÂ≠óÔºåÊØèË°å‰∏ÄÂÄã„ÄÇÁ≥ªÁµ±Â∞áËá™ÂãïÊü•Ë©¢‰∏¶Êì∑ÂèñÊØèÂÄãÈóúÈçµÂ≠óÁöÑÁÖßÁâáÁõ¥Êé•ÈÄ£Áµê„ÄÇ</p>
                <textarea id="batch-keywords" class="batch-textarea" placeholder="Ë´ãËº∏ÂÖ•Êü•Ë©¢ÈóúÈçµÂ≠óÔºåÊØèË°å‰∏ÄÂÄã...
‰æãÂ¶ÇÔºö
‰∏ÉÊòüÂ±±
ÈôΩÊòéÂ±±
Â∞èÊ≤πÂùë
ÊìéÂ§©Â¥ó
ÂÜ∑Ê∞¥Âùë"></textarea>
                
                <div class="search-options">
                    <div class="search-option">
                        <input type="number" id="batch-limit-input" min="1" max="20" value="5" style="width: 60px;">
                        <label for="batch-limit-input">ÊØèÂÄãÈóúÈçµÂ≠óÁöÑÁµêÊûúÊï∏Èáè</label>
                    </div>
                </div>
                
                <div class="batch-controls">
                    <button id="start-batch" class="button-primary">ÈñãÂßãÊâπÊ¨°Êü•Ë©¢</button>
                    <button id="import-batch-keywords" class="button-accent">ÂåØÂÖ•ÈóúÈçµÂ≠óÊ∏ÖÂñÆ</button>
                    <input type="file" id="batch-keywords-file" class="file-input" accept=".txt,.csv">
                    <label for="batch-keywords-file" class="file-label">ÈÅ∏ÊìáÊñáÂ≠óÊ™î</label>
                </div>
                
                <div id="batch-status" class="batch-status">
                    <div id="batch-status-text"></div>
                    <div class="batch-progress">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>
                
                <div id="batch-results" class="batch-results">
                    <!-- ÊâπÊ¨°Êü•Ë©¢ÁµêÊûúÂ∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
                </div>
                
                <div class="batch-actions">
                    <button id="batch-save-all" class="button-success">ÂÑ≤Â≠òÊâÄÊúâÈÄ£Áµê</button>
                    <button id="batch-export-json" class="button-success">ÂåØÂá∫ JSON</button>
                    <button id="batch-export-text" class="button-success">ÂåØÂá∫ÊñáÂ≠óÊ™î</button>
                    <button id="batch-export-html" class="button-success">ÂåØÂá∫ HTML</button>
                </div>
            </div>
        </div>
        
        <!-- Â∑≤ÂÑ≤Â≠òÈÄ£ÁµêÊ®ôÁ±§È†Å -->
        <div id="saved-tab" class="tab-content">
            <h2 class="section-title">Â∑≤ÂÑ≤Â≠òÁöÑÈÄ£Áµê</h2>
            <div id="saved-links-container" class="saved-links-list">
                <div class="saved-links-empty">Â∞öÊú™ÂÑ≤Â≠ò‰ªª‰ΩïÈÄ£Áµê</div>
            </div>
            
            <div class="file-import">
                <input type="file" id="import-file" class="file-input" accept=".json">
                <label for="import-file" class="file-label">ÈÅ∏Êìá JSON Ê™îÊ°àÂåØÂÖ•</label>
                <button id="import-json" class="button-primary">ÂåØÂÖ• JSON</button>
                <button id="clear-all" class="button-danger">Ê∏ÖÈô§ÊâÄÊúâÈÄ£Áµê</button>
            </div>
        </div>
        
        <!-- ÂåØÂá∫Ë≥áÊñôÊ®ôÁ±§È†Å -->
        <div id="export-tab" class="tab-content">
            <h2 class="section-title">ÂåØÂá∫Ë≥áÊñô</h2>
            <p>ÈÅ∏ÊìáÂåØÂá∫Ê†ºÂºèÔºåÂ∞áÊÇ®Êî∂ÈõÜÁöÑÁÖßÁâáÈÄ£Áµê‰øùÂ≠òÂà∞Ê™îÊ°à‰∏≠„ÄÇ</p>
            
            <div class="export-section">
                <button id="export-json" class="button-success">ÂåØÂá∫ JSON</button>
                <button id="export-text" class="button-success">ÂåØÂá∫ÊñáÂ≠óÊ™î</button>
                <button id="export-html" class="button-success">ÂåØÂá∫ HTML</button>
            </div>
            
            <div id="export-preview" class="export-preview">
                <p>ÂåØÂá∫È†êË¶ΩÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°</p>
            </div>
        </div>
    </div>
    
    <!-- ÁÖßÁâáË©≥Á¥∞Ë≥áË®äÊ®°ÊÖãÊ°Ü -->
    <div id="photo-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2 id="modal-title">ÁÖßÁâáË©≥Á¥∞Ë≥áË®ä</h2>
            <div class="modal-image-container">
                <img id="modal-image" class="modal-image" src="" alt="ÁÖßÁâáË©≥Á¥∞È†êË¶Ω">
            </div>
            <div class="modal-links">
                <div class="modal-link-item">
                    <span class="link-label">Áõ¥Êé•ÈÄ£Áµê</span>
                    <span id="modal-direct-link" class="modal-link-text"></span>
                    <button id="modal-copy-direct" class="icon-button copy-icon" title="Ë§áË£ΩÈÄ£Áµê"></button>
                    <button id="modal-open-direct" class="icon-button open-icon" title="ÈñãÂïüÈÄ£Áµê"></button>
                </div>
            </div>
            <div class="photo-actions" style="margin-top: 20px;">
                <button id="modal-save" class="photo-button button-success">ÂÑ≤Â≠òÈÄ£Áµê</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // <!-- STAGE 1: Âü∫Êú¨Ë®≠ÁΩÆËàáÂàùÂßãÂåñ -->
        
        // ÂÖ®ÂüüËÆäÊï∏
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const limitInput = document.getElementById('limit-input');
        const saveTop5Button = document.getElementById('save-top-5');
        const resultsContainer = document.getElementById('results-container');
        const savedLinksContainer = document.getElementById('saved-links-container');
        const exportJsonButton = document.getElementById('export-json');
        const exportTextButton = document.getElementById('export-text');
        const exportHtmlButton = document.getElementById('export-html');
        const exportPreview = document.getElementById('export-preview');
        const clearAllButton = document.getElementById('clear-all');
        const importFileInput = document.getElementById('import-file');
        const importJsonButton = document.getElementById('import-json');
        const loadingIndicator = document.querySelector('.loading');
        const notification = document.getElementById('notification');
        
        // ÊâπÊ¨°Êü•Ë©¢Áõ∏Èóú
        const batchKeywordsTextarea = document.getElementById('batch-keywords');
        const batchLimitInput = document.getElementById('batch-limit-input');
        const startBatchButton = document.getElementById('start-batch');
        const importBatchKeywordsButton = document.getElementById('import-batch-keywords');
        const batchKeywordsFileInput = document.getElementById('batch-keywords-file');
        const batchStatus = document.getElementById('batch-status');
        const batchStatusText = document.getElementById('batch-status-text');
        const progressBar = document.getElementById('progress-bar');
        const batchResults = document.getElementById('batch-results');
        const batchSaveAllButton = document.getElementById('batch-save-all');
        const batchExportJsonButton = document.getElementById('batch-export-json');
        const batchExportTextButton = document.getElementById('batch-export-text');
        const batchExportHtmlButton = document.getElementById('batch-export-html');
        
        // Ê®°ÊÖãÊ°ÜÂÖÉÁ¥†
        const photoModal = document.getElementById('photo-modal');
        const closeModal = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImage = document.getElementById('modal-image');
        const modalDirectLink = document.getElementById('modal-direct-link');
        const modalCopyDirect = document.getElementById('modal-copy-direct');
        const modalOpenDirect = document.getElementById('modal-open-direct');
        const modalSave = document.getElementById('modal-save');
        
        // Áï∂ÂâçÊ®°ÊÖãÊ°ÜÈ°ØÁ§∫ÁöÑÁÖßÁâáË≥áË®ä
        let currentModalPhoto = null;
        // Áï∂ÂâçÊêúÂ∞ãÈóúÈçµÂ≠ó
        let currentSearchKeyword = '';
        
        // Áî®ÊñºÂÑ≤Â≠òÂ∑≤‰øùÂ≠òÁöÑÈÄ£Áµê
        let savedLinks = [];
        
        // ÂÑ≤Â≠òÊâπÊ¨°Êü•Ë©¢ÁµêÊûú
        let batchQueryResults = [];
        
        // ÂàùÂßãÂåñÈ†ÅÈù¢
        function initPage() {
            // Ê®ôÁ±§È†ÅÂàáÊèõ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Êõ¥Êñ∞ÂÖßÂÆπÂçÄÂ°äÁãÄÊÖã
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // ÂñÆ‰∏ÄÊêúÂ∞ãÊ®ôÁ±§È†Å‰∫ã‰ª∂
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchPhotos();
                }
            });
            
            searchButton.addEventListener('click', searchPhotos);
            saveTop5Button.addEventListener('click', saveTop5Results);
            
            // ÂåØÂá∫Ê®ôÁ±§È†Å‰∫ã‰ª∂
            exportJsonButton.addEventListener('click', () => {
                exportJson(savedLinks);
                showExportPreview('json');
            });
            exportTextButton.addEventListener('click', () => {
                exportText(savedLinks);
                showExportPreview('text');
            });
            exportHtmlButton.addEventListener('click', () => {
                exportHtml(savedLinks);
                showExportPreview('html');
            });
            
            // Â∑≤ÂÑ≤Â≠òÈÄ£ÁµêÊ®ôÁ±§È†Å‰∫ã‰ª∂
            clearAllButton.addEventListener('click', clearAllLinks);
            importJsonButton.addEventListener('click', importJsonFile);
            
            // ÊâπÊ¨°Êü•Ë©¢Ê®ôÁ±§È†Å‰∫ã‰ª∂
            startBatchButton.addEventListener('click', startBatchQuery);
            importBatchKeywordsButton.addEventListener('click', () => batchKeywordsFileInput.click());
            batchKeywordsFileInput.addEventListener('change', importBatchKeywords);
            batchSaveAllButton.addEventListener('click', saveBatchResults);
            batchExportJsonButton.addEventListener('click', () => {
                exportJson(batchQueryResults, 'wikimedia_batch_links.json');
                showExportPreview('json', batchQueryResults);
            });
            batchExportTextButton.addEventListener('click', () => {
                exportText(batchQueryResults, 'wikimedia_batch_links.txt');
                showExportPreview('text', batchQueryResults);
            });
            batchExportHtmlButton.addEventListener('click', () => {
                exportHtml(batchQueryResults, 'wikimedia_batch_photos.html');
                showExportPreview('html', batchQueryResults);
            });
            
            // Ê®°ÊÖãÊ°ÜÁõ∏Èóú‰∫ã‰ª∂
            closeModal.addEventListener('click', closePhotoModal);
            modalCopyDirect.addEventListener('click', () => copyToClipboard(modalDirectLink.textContent));
            modalOpenDirect.addEventListener('click', () => window.open(modalDirectLink.textContent, '_blank'));
            modalSave.addEventListener('click', saveModalPhoto);
            
            // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
            window.addEventListener('click', function(e) {
                if (e.target === photoModal) {
                    closePhotoModal();
                }
            });
            
            // ÈôêÂà∂ÊêúÂ∞ãÁµêÊûúÊï∏ÈáèÁöÑËº∏ÂÖ•ÁØÑÂúç
            limitInput.addEventListener('change', function() {
                if (this.value < 5) this.value = 5;
                if (this.value > 50) this.value = 50;
            });
            
            // ÈôêÂà∂ÊâπÊ¨°Êü•Ë©¢ÁµêÊûúÊï∏ÈáèÁöÑËº∏ÂÖ•ÁØÑÂúç
            batchLimitInput.addEventListener('change', function() {
                if (this.value < 1) this.value = 1;
                if (this.value > 20) this.value = 20;
            });
            
            // ÂàùÂßãÂåñÂ∑≤ÂÑ≤Â≠òÁöÑÈÄ£ÁµêÂçÄÂüü
            renderSavedLinks();
        }
        
        // <!-- STAGE 2: ÂñÆ‰∏ÄÊêúÂ∞ãÂäüËÉΩ -->
        
        // ÊêúÂ∞ã Wikimedia Commons ÁÖßÁâá
        function searchPhotos() {
            const searchTerm = searchInput.value.trim();
            currentSearchKeyword = searchTerm;
            
            if (searchTerm === '') {
                showNotification('Ë´ãËº∏ÂÖ•ÊêúÂ∞ãÈóúÈçµÂ≠ó', true);
                return;
            }
            
            loadingIndicator.style.display = 'block';
            resultsContainer.innerHTML = '';
            
            const limit = parseInt(limitInput.value) || 20;
            
            // ÊßãÂª∫ Wikimedia Commons API Ë´ãÊ±Ç‰æÜÊêúÂ∞ãÁÖßÁâá
            const searchApiUrl = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(searchTerm)}+filetype:bitmap|drawing&srnamespace=6&format=json&origin=*&srlimit=${limit}`;
            
            fetch(searchApiUrl)
                .then(response => response.json())
                .then(data => {
                    if (!data.query || !data.query.search || data.query.search.length === 0) {
                        loadingIndicator.style.display = 'none';
                        resultsContainer.innerHTML = '<div class="no-results">Êú™ÊâæÂà∞Áõ∏ÈóúÁÖßÁâá</div>';
                        return;
                    }
                    
                    // Áç≤ÂèñÊêúÂ∞ãÁµêÊûú
                    const searchResults = data.query.search;
                    processSearchResults(searchResults);
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    resultsContainer.innerHTML = '<div class="no-results">ÊêúÂ∞ãÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶</div>';
                    console.error('ÊêúÂ∞ãÈåØË™§:', error);
                });
        }
        
        // ÂÑ≤Â≠òÂâç 5 Á≠ÜÊêúÂ∞ãÁµêÊûú
        function saveTop5Results() {
            const photoCards = resultsContainer.querySelectorAll('.photo-card');
            
            if (photoCards.length === 0) {
                showNotification('Ê≤íÊúâÂèØÂÑ≤Â≠òÁöÑÊêúÂ∞ãÁµêÊûú', true);
                return;
            }
            
            let savedCount = 0;
            const maxToSave = Math.min(5, photoCards.length);
            
            for (let i = 0; i < maxToSave; i++) {
                const saveButton = photoCards[i].querySelector('.save-link');
                if (saveButton) {
                    saveButton.click();
                    savedCount++;
                }
            }
            
            if (savedCount > 0) {
                showNotification(`Â∑≤ÂÑ≤Â≠òÂâç ${savedCount} Á≠ÜÊêúÂ∞ãÁµêÊûú`);
            } else {
                showNotification('ÁÑ°Ê≥ïËá™ÂãïÂÑ≤Â≠ò‰ªª‰ΩïÁµêÊûúÔºåË´ãÊâãÂãïÂÑ≤Â≠ò', true);
            }
        }
        
        // ËôïÁêÜÊêúÂ∞ãÁµêÊûúÔºåÁç≤ÂèñÊõ¥Â§öË©≥Á¥∞Ë≥áË®ä
        function processSearchResults(searchResults) {
            resultsContainer.innerHTML = '';
            let completedCount = 0;
            
            searchResults.forEach(result => {
                // ÂæûÁµêÊûúÊ®ôÈ°å‰∏≠ÂèñÂæóÊ™îÊ°àÂêçÁ®±
                const fileName = result.title.replace('File:', '');
                
                // ÊßãÂª∫Ë©≥ÊÉÖÈ†ÅÈù¢ URL
                const detailPageUrl = `https://commons.wikimedia.org/wiki/File:${encodeURIComponent(fileName)}`;
                
                // Áç≤ÂèñÊ™îÊ°àË≥áË®äÂíåÈÄ£Áµê
                fetchFileInfo(fileName, detailPageUrl)
                    .then(fileInfo => {
                        // Ê∑ªÂä†ÊêúÂ∞ãÈóúÈçµÂ≠óÂà∞Ê™îÊ°àË≥áË®ä‰∏≠
                        fileInfo.searchKeyword = currentSearchKeyword;
                        renderPhotoCard(fileInfo);
                    })
                    .catch(error => {
                        console.error(`Áç≤ÂèñÊ™îÊ°àË≥áË®äÈåØË™§ (${fileName}):`, error);
                        // ÂòóË©¶‰ΩøÁî®ÂÇôÁî®ÊñπÊ≥ïÊâæÂà∞Áõ¥Êé•ÈÄ£Áµê
                        const fallbackInfo = {
                            title: fileName,
                            pageUrl: detailPageUrl,
                            directUrl: null, // ÁÑ°Ê≥ïÈÄöÈÅé API Áç≤ÂèñÔºåÂ∞áÂú®Áî®Êà∂‰∫§‰∫íÊôÇÂòóË©¶
                            thumbUrl: `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}?width=300`,
                            searchKeyword: currentSearchKeyword
                        };
                        renderPhotoCard(fallbackInfo);
                    })
                    .finally(() => {
                        completedCount++;
                        if (completedCount === searchResults.length) {
                            loadingIndicator.style.display = 'none';
                        }
                    });
            });
        }
        
        // Áç≤ÂèñÊ™îÊ°àÁöÑË©≥Á¥∞Ë≥áË®äÔºåÂ∞§ÂÖ∂ÊòØÁõ¥Êé•ÈÄ£Áµê
        async function fetchFileInfo(fileName, detailPageUrl) {
            // ÊßãÂª∫Áç≤ÂèñÊ™îÊ°àË≥áË®äÁöÑ API URL
            const fileInfoUrl = `https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url|size|mime&format=json&origin=*`;
            
            try {
                const response = await fetch(fileInfoUrl);
                const data = await response.json();
                
                if (!data.query || !data.query.pages) {
                    throw new Error('ÁÑ°ÊïàÁöÑ API ÂõûÊáâ');
                }
                
                // ÂæûÂõûÊáâ‰∏≠ÊèêÂèñÈ†ÅÈù¢Ë≥áË®ä
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId === '-1' || !pages[pageId].imageinfo || pages[pageId].imageinfo.length === 0) {
                    throw new Error('Êâæ‰∏çÂà∞Ê™îÊ°àË≥áË®ä');
                }
                
                const imageInfo = pages[pageId].imageinfo[0];
                
                // ÈÄôË£°Áç≤ÂèñÁöÑ url Â∞±ÊòØÁÖßÁâáÁöÑÁõ¥Êé•ÈÄ£Áµê
                const directUrl = imageInfo.url;
                
                // ÊßãÂª∫Á∏ÆÂúñ URL
                const thumbUrl = `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}?width=300`;
                
                return {
                    title: fileName,
                    pageUrl: detailPageUrl,
                    directUrl: directUrl,
                    thumbUrl: thumbUrl,
                    width: imageInfo.width,
                    height: imageInfo.height,
                    size: imageInfo.size,
                    mime: imageInfo.mime
                };
            } catch (error) {
                console.error('Áç≤ÂèñÊ™îÊ°àË©≥Á¥∞Ë≥áË®äÈåØË™§:', error);
                throw error;
            }
        }
        
        // Ê∏≤ÊüìÁÖßÁâáÂç°Áâá
        function renderPhotoCard(photoInfo) {
            const photoCard = document.createElement('div');
            photoCard.className = 'photo-card';
            
            const hasDirectUrl = photoInfo.directUrl !== null;
            
            let photoContent = `
                <div class="photo-image-container">
                    <img src="${photoInfo.thumbUrl}" alt="${photoInfo.title}" class="photo-image" onerror="this.src='https://via.placeholder.com/200x150?text=ÂúñÁâáËºâÂÖ•Â§±Êïó'">
                    <div class="drag-instruction">${hasDirectUrl ? 'ÈªûÊìäÊü•ÁúãÂ§ßÂúñ' : 'ÂúñÁâáÊãñÊõ≥ÂèØÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê'}</div>
                </div>
                <div class="photo-details">
                    <h3 class="photo-title">${photoInfo.title}</h3>
            `;
            
            if (hasDirectUrl) {
                photoContent += `
                    <div class="photo-links">
                        <div class="photo-link">
                            <span class="link-label">Áõ¥Êé•ÈÄ£Áµê</span>
                            <span class="link-content" title="${photoInfo.directUrl}">${photoInfo.directUrl.substring(0, 25)}...</span>
                            <div class="action-buttons">
                                <button class="icon-button copy-icon copy-direct-link" title="Ë§áË£ΩÁõ¥Êé•ÈÄ£Áµê" data-url="${photoInfo.directUrl}"></button>
                                <button class="icon-button open-icon open-direct-link" title="ÈñãÂïüÁõ¥Êé•ÈÄ£Áµê" data-url="${photoInfo.directUrl}"></button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                photoContent += `
                    <div class="photo-links">
                        <div class="photo-link">
                            <span class="link-label">Áõ¥Êé•ÈÄ£Áµê</span>
                            <span class="link-content" style="color: #e74c3c;">ÁÑ°Ê≥ïËá™ÂãïÁç≤ÂèñÔºåË´ãÊãñÊõ≥ÂúñÁâá</span>
                        </div>
                    </div>
                `;
            }
            
            photoContent += `
                    <div class="photo-actions">
                        <button class="photo-button button-primary view-details">Êü•ÁúãË©≥Á¥∞Ë≥áË®ä</button>
                        ${hasDirectUrl ? '<button class="photo-button button-success save-link">ÂÑ≤Â≠òÈÄ£Áµê</button>' : ''}
                    </div>
                </div>
            `;
            
            photoCard.innerHTML = photoContent;
            
            // ÁÖßÁâáÊãñÊõ≥‰∫ã‰ª∂ÔºàÁî®ÊñºÁç≤ÂèñÁõ¥Êé•ÈÄ£ÁµêÔºâ
            const photoImage = photoCard.querySelector('.photo-image');
            photoImage.addEventListener('dragstart', function(e) {
                e.preventDefault();
                showPhotoModal(photoInfo);
            });
            
            // ÈªûÊìäÂúñÁâáÊü•ÁúãË©≥Á¥∞Ë≥áË®ä
            photoImage.addEventListener('click', function() {
                showPhotoModal(photoInfo);
            });
            
            // Êü•ÁúãË©≥Á¥∞Ë≥áË®äÊåâÈàïÈªûÊìä‰∫ã‰ª∂
            const viewDetailsButton = photoCard.querySelector('.view-details');
            viewDetailsButton.addEventListener('click', function() {
                showPhotoModal(photoInfo);
            });
            
            // Â¶ÇÊûúÊúâÁõ¥Êé•ÈÄ£ÁµêÔºåÊ∑ªÂä†ÂÑ≤Â≠òÊåâÈàïÈªûÊìä‰∫ã‰ª∂
            if (hasDirectUrl) {
                const saveButton = photoCard.querySelector('.save-link');
                saveButton.addEventListener('click', function() {
                    saveLinkItem(photoInfo);
                });
                
                // Ë§áË£ΩÁõ¥Êé•ÈÄ£ÁµêÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                const copyDirectButton = photoCard.querySelector('.copy-direct-link');
                copyDirectButton.addEventListener('click', function() {
                    copyToClipboard(photoInfo.directUrl);
                });
                
                // ÈñãÂïüÁõ¥Êé•ÈÄ£ÁµêÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                const openDirectButton = photoCard.querySelector('.open-direct-link');
                openDirectButton.addEventListener('click', function() {
                    window.open(photoInfo.directUrl, '_blank');
                });
            }
            
            resultsContainer.appendChild(photoCard);
        }
        
        // <!-- STAGE 3: Ê®°ÊÖãÊ°ÜËàáË≥áÊñôËôïÁêÜÂäüËÉΩ -->
        
        // È°ØÁ§∫ÁÖßÁâáË©≥Á¥∞Ë≥áË®äÊ®°ÊÖãÊ°Ü
        function showPhotoModal(photoInfo) {
            currentModalPhoto = photoInfo;
            
            modalTitle.textContent = photoInfo.title;
            
            // ‰ΩøÁî®ÂÆåÊï¥Â∞∫ÂØ∏ÂúñÁâáÔºàÂ¶ÇÊûúÊúâÁõ¥Êé•ÈÄ£ÁµêÔºâÊàñÁ∏ÆÂúñ
            modalImage.src = photoInfo.directUrl || photoInfo.thumbUrl;
            modalImage.alt = photoInfo.title;
            
            // Ë®≠ÁΩÆÈÄ£ÁµêË≥áË®ä
            modalDirectLink.textContent = photoInfo.directUrl || 'ÁÑ°Ê≥ïËá™ÂãïÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê';
            
            // Â¶ÇÊûúÊ≤íÊúâÁõ¥Êé•ÈÄ£ÁµêÔºåÁ¶ÅÁî®Áõ∏ÈóúÊåâÈàï
            if (!photoInfo.directUrl) {
                modalCopyDirect.disabled = true;
                modalOpenDirect.disabled = true;
                modalCopyDirect.style.opacity = 0.5;
                modalOpenDirect.style.opacity = 0.5;
                
                // ÁÇ∫Ê®°ÊÖãÊ°ÜÂúñÁâáÊ∑ªÂä†ÊãñÊõ≥‰∫ã‰ª∂Áõ£ËÅΩÔºå‰ª•‰æøÁî®Êà∂ÂèØ‰ª•ÂòóË©¶ÊâãÂãïÁç≤ÂèñÈÄ£Áµê
                modalImage.style.cursor = 'move';
                modalImage.setAttribute('draggable', 'true');
                modalImage.addEventListener('dragstart', handleImageDragStart);
            } else {
                modalCopyDirect.disabled = false;
                modalOpenDirect.disabled = false;
                modalCopyDirect.style.opacity = 1;
                modalOpenDirect.style.opacity = 1;
                
                modalImage.style.cursor = 'default';
                modalImage.setAttribute('draggable', 'false');
                modalImage.removeEventListener('dragstart', handleImageDragStart);
            }
            
            // Â¶ÇÊûúÂ∑≤Á∂ì‰øùÂ≠òÈÅéÊ≠§ÈÄ£ÁµêÔºåÊõ¥ÊîπÂÑ≤Â≠òÊåâÈàïÊñáÂ≠ó
            const isAlreadySaved = savedLinks.some(link => 
                (photoInfo.directUrl && link.directUrl === photoInfo.directUrl)
            );
            
            modalSave.textContent = isAlreadySaved ? 'Â∑≤ÂÑ≤Â≠ò' : 'ÂÑ≤Â≠òÈÄ£Áµê';
            modalSave.disabled = isAlreadySaved;
            modalSave.style.opacity = isAlreadySaved ? 0.7 : 1;
            
            // È°ØÁ§∫Ê®°ÊÖãÊ°Ü
            photoModal.style.display = 'block';
            
            // Ê™¢Êü•Ê®°ÊÖãÊ°Ü‰ΩçÁΩÆÔºåÁ¢∫‰øù‰∏çÊúÉË¢´È†ÅÈù¢ÈÇäÁ∑£Ë£ÅÂàá
            setTimeout(adjustModalPosition, 100);
        }
        
        // Ë™øÊï¥Ê®°ÊÖãÊ°Ü‰ΩçÁΩÆÔºåÈÅøÂÖçÈÇäÁ∑£Ë£ÅÂàá
        function adjustModalPosition() {
            const modalContent = photoModal.querySelector('.modal-content');
            const rect = modalContent.getBoundingClientRect();
            
            // Ê™¢Êü•È†ÇÈÉ®ÈÇäÁ∑£
            if (rect.top < 0) {
                modalContent.style.margin = '10px auto';
                modalContent.style.maxHeight = '90vh';
                modalContent.style.overflow = 'auto';
            }
            
            // Ê™¢Êü•Â∫ïÈÉ®ÈÇäÁ∑£
            if (rect.bottom > window.innerHeight) {
                modalContent.style.margin = '10px auto';
                modalContent.style.maxHeight = '90vh';
                modalContent.style.overflow = 'auto';
            }
            
            // Ê™¢Êü•Â∑¶Âè≥ÈÇäÁ∑£
            if (rect.left < 0 || rect.right > window.innerWidth) {
                modalContent.style.width = '95%';
                modalContent.style.maxWidth = '95vw';
            }
        }
        
        // ÈóúÈñâÁÖßÁâáË©≥Á¥∞Ë≥áË®äÊ®°ÊÖãÊ°Ü
        function closePhotoModal() {
            photoModal.style.display = 'none';
            // ÈáçË®≠Ê®°ÊÖãÊ°ÜÁöÑ‰ΩçÁΩÆÂíåÂ§ßÂ∞è
            const modalContent = photoModal.querySelector('.modal-content');
            modalContent.style.margin = '5% auto';
            modalContent.style.maxHeight = '';
            modalContent.style.overflow = '';
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '800px';
            
            currentModalPhoto = null;
        }
        
        // ËôïÁêÜÂúñÁâáÊãñÊõ≥ÈñãÂßã‰∫ã‰ª∂
        function handleImageDragStart(e) {
            // Â¶ÇÊûúÁî®Êà∂ÂòóË©¶ÊãñÊõ≥ÂúñÁâáÁç≤ÂèñÈÄ£ÁµêÔºåÂèØ‰ª•Âæû‰∫ã‰ª∂‰∏≠Áç≤ÂèñÂúñÁâáÁöÑ URL
            const imgSrc = e.target.src;
            
            // Â∞áÁç≤ÂèñÁöÑ URL Ë®≠ÁΩÆÁÇ∫Áõ¥Êé•ÈÄ£Áµê
            if (imgSrc && currentModalPhoto) {
                // ËΩâÊèõÊàêÁ¨¶ÂêàÈ†êÊúüÊ†ºÂºèÁöÑ URL
                const directUrl = convertToDirectUrl(imgSrc, currentModalPhoto.title);
                
                // Êõ¥Êñ∞Ê®°ÊÖãÊ°ÜÂíåÁï∂ÂâçÁÖßÁâá‰ø°ÊÅØ
                modalDirectLink.textContent = directUrl;
                currentModalPhoto.directUrl = directUrl;
                
                // ÂïüÁî®Áõ∏ÈóúÊåâÈàï
                modalCopyDirect.disabled = false;
                modalOpenDirect.disabled = false;
                modalCopyDirect.style.opacity = 1;
                modalOpenDirect.style.opacity = 1;
                
                showNotification('Â∑≤ÊàêÂäüÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê');
            }
        }
        
        // Â∞áÂêÑÁ®ÆÊ†ºÂºèÁöÑ URL ËΩâÊèõÁÇ∫Ê®ôÊ∫ñÁöÑÁõ¥Êé•ÈÄ£ÁµêÊ†ºÂºè
        function convertToDirectUrl(url, fileName) {
            // Â¶ÇÊûú URL Â∑≤Á∂ìÊòØÊ®ôÊ∫ñÁöÑ upload.wikimedia.org Ê†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
            if (url.includes('upload.wikimedia.org/wikipedia/commons')) {
                return url;
            }
            
            // Â¶ÇÊûúÊòØÁ∏ÆÂúñ URLÔºåËΩâÊèõÁÇ∫ÂéüÂßã URL
            if (url.includes('/thumb/')) {
                // ÁßªÈô§Á∏ÆÂúñÈÉ®ÂàÜ
                const baseUrl = url.split('/thumb/').join('/');
                // ÁßªÈô§Â∞∫ÂØ∏ÈÉ®ÂàÜÔºàÂ¶Ç /300px-Êñá‰ª∂ÂêçÔºâ
                return baseUrl.replace(/\/\d+px-[^\/]+$/, '');
            }
            
            // Â¶ÇÊûúÊòØ Special:FilePath Ê†ºÂºèÔºåËΩâÊèõÁÇ∫Áõ¥Êé•ÈÄ£Áµê
            if (url.includes('Special:FilePath')) {
                // Â¶ÇÊûúÁÑ°Ê≥ïÁõ¥Êé•ËΩâÊèõÔºåÁõ¥Êé•ËøîÂõûÂéüÂßã URL
                return url;
            }
            
            // Â¶ÇÊûúÁÑ°Ê≥ïÁ¢∫ÂÆöÊ†ºÂºèÔºåËøîÂõûÂéüÂßã URL
            return url;
        }
        
        // ÂâµÂª∫Á∏ÆÂúñURLÁöÑËºîÂä©ÂáΩÊï∏
        function createThumbUrl(directUrl, size = 300) {
            // Â¶ÇÊûúdirectUrlÊòØWikimedia‰∏äÂÇ≥ÈÄ£ÁµêÔºåÂâµÂª∫‰∏ÄÂÄãÁ∏ÆÂúñÁâàÊú¨
            if (directUrl.includes('upload.wikimedia.org/wikipedia/commons')) {
                try {
                    // ÊèêÂèñÊ™îÊ°àÂêçÁ®±
                    const fileName = directUrl.split('/').pop();
                    
                    // Âª∫Á´ãÁ∏ÆÂúñURLË∑ØÂæë
                    let thumbUrl = directUrl;
                    
                    // Â¶ÇÊûú‰∏çÊòØÂ∑≤Á∂ìÊòØÁ∏ÆÂúñË∑ØÂæë
                    if (!directUrl.includes('/thumb/')) {
                        thumbUrl = directUrl.replace('/wikipedia/commons/', '/wikipedia/commons/thumb/');
                        thumbUrl = `${thumbUrl}/${size}px-${fileName}`;
                    }
                    
                    return thumbUrl;
                } catch (error) {
                    console.error('ÂâµÂª∫Á∏ÆÂúñURLÈåØË™§:', error);
                    return directUrl;
                }
            }
            
            // Â¶ÇÊûúÁÑ°Ê≥ïÂâµÂª∫Á∏ÆÂúñURLÔºåËøîÂõûÂéüÂßãURL
            return directUrl;
        }
        
        // ÂÑ≤Â≠òÊ®°ÊÖãÊ°Ü‰∏≠ÁöÑÁÖßÁâáÈÄ£Áµê
        function saveModalPhoto() {
            if (currentModalPhoto && currentModalPhoto.directUrl) {
                saveLinkItem(currentModalPhoto);
                
                // Êõ¥Êñ∞Ê®°ÊÖãÊ°ÜÂÑ≤Â≠òÊåâÈàïÁãÄÊÖã
                modalSave.textContent = 'Â∑≤ÂÑ≤Â≠ò';
                modalSave.disabled = true;
                modalSave.style.opacity = 0.7;
            } else {
                showNotification('ÁÑ°Ê≥ïÂÑ≤Â≠òÈÄ£ÁµêÔºåË´ãÂÖàÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê', true);
            }
        }
        
        // Ë§áË£ΩÊñáÂ≠óÂà∞Ââ™Ë≤ºÁ∞ø
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Â∑≤Ë§áË£ΩÈÄ£ÁµêÂà∞Ââ™Ë≤ºÁ∞ø');
                } else {
                    showNotification('ÁÑ°Ê≥ïË§áË£ΩÈÄ£ÁµêÔºåË´ãÊâãÂãïË§áË£Ω', true);
                }
            } catch (err) {
                showNotification('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω', true);
            }
            
            document.body.removeChild(textarea);
        }
        
        // <!-- STAGE 4: ÈÄ£ÁµêÁÆ°ÁêÜÂäüËÉΩ -->
        
        // ÂÑ≤Â≠òÈÄ£Áµê
        function saveLinkItem(linkData) {
            // Âè™ÊúâÂú®ÊúâÁõ¥Êé•ÈÄ£ÁµêÊôÇÊâçÂÑ≤Â≠ò
            if (!linkData.directUrl) {
                showNotification('ÁÑ°Ê≥ïÂÑ≤Â≠òÈÄ£ÁµêÔºåË´ãÂÖàÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê', true);
                return;
            }
            
            // Ê™¢Êü•ÈÄ£ÁµêÊòØÂê¶Â∑≤Â≠òÂú®
            const linkExists = savedLinks.some(link => link.directUrl === linkData.directUrl);
            
            if (!linkExists) {
                // ÂÑ≤Â≠òÈúÄË¶ÅÁöÑË≥áË®äÔºàÁõ¥Êé•ÈÄ£Áµê„ÄÅÊ®ôÈ°å„ÄÅÁ∏ÆÂúñURLÂíåÊêúÂ∞ãÈóúÈçµÂ≠óÔºâ
                savedLinks.push({
                    title: linkData.title,
                    directUrl: linkData.directUrl,
                    thumbUrl: linkData.thumbUrl || createThumbUrl(linkData.directUrl),
                    searchKeyword: linkData.searchKeyword || currentSearchKeyword || '',
                    dateAdded: new Date().toISOString()
                });
                renderSavedLinks();
                showNotification('ÈÄ£ÁµêÂ∑≤ÊàêÂäüÂÑ≤Â≠ò');
            } else {
                showNotification('Ê≠§ÈÄ£ÁµêÂ∑≤Â≠òÂú®ÊñºÂ∑≤ÂÑ≤Â≠òÊ∏ÖÂñÆ‰∏≠', true);
            }
        }
        
        // Ê∏≤ÊüìÂ∑≤ÂÑ≤Â≠òÁöÑÈÄ£Áµê
        function renderSavedLinks() {
            if (savedLinks.length === 0) {
                savedLinksContainer.innerHTML = '<div class="saved-links-empty">Â∞öÊú™ÂÑ≤Â≠ò‰ªª‰ΩïÈÄ£Áµê</div>';
                return;
            }
            
            savedLinksContainer.innerHTML = '';
            
            savedLinks.forEach((link, index) => {
                const linkItem = document.createElement('div');
                linkItem.className = 'saved-link-item';
                
                // È°ØÁ§∫Ê®ôÈ°åÂíåÈóúÈçµÂ≠óÔºàÂ¶ÇÊûúÊúâÔºâ
                let keywordHtml = '';
                if (link.searchKeyword) {
                    keywordHtml = `<span class="saved-link-keyword">${link.searchKeyword}</span>`;
                }
                
                // ‰ΩøÁî®Á∏ÆÂúñURLÊàñÁõ¥Êé•ÈÄ£Áµê‰ΩúÁÇ∫Á∏ÆÂúñ
                const thumbUrl = link.thumbUrl || createThumbUrl(link.directUrl);
                
                let linkContent = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div class="saved-link-thumb" style="min-width: 100px; width: 100px;">
                            <img src="${thumbUrl}" alt="${link.title}" style="width: 100%; height: auto; border-radius: 4px; display: block;" onerror="this.src='https://via.placeholder.com/100x75?text=ÂúñÁâáËºâÂÖ•Â§±Êïó'">
                        </div>
                        <div style="flex-grow: 1;">
                            <div class="saved-link-title">
                                <span>${link.title}</span>
                                ${keywordHtml}
                            </div>
                            <div class="saved-link-url">${link.directUrl}</div>
                            <div class="saved-link-actions">
                                <button class="button-primary view-direct">Êü•ÁúãÁÖßÁâá</button>
                                <button class="button-primary copy-link">Ë§áË£ΩÈÄ£Áµê</button>
                                <button class="button-danger remove-link">ÁßªÈô§</button>
                            </div>
                        </div>
                    </div>
                `;
                
                linkItem.innerHTML = linkContent;
                
                // Êü•ÁúãÁõ¥Êé•ÈÄ£ÁµêÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                const viewDirectButton = linkItem.querySelector('.view-direct');
                viewDirectButton.addEventListener('click', function() {
                    window.open(link.directUrl, '_blank');
                });
                
                // Ë§áË£ΩÈÄ£ÁµêÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                const copyLinkButton = linkItem.querySelector('.copy-link');
                copyLinkButton.addEventListener('click', function() {
                    copyToClipboard(link.directUrl);
                });
                
                // ÁßªÈô§ÈÄ£ÁµêÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                const removeButton = linkItem.querySelector('.remove-link');
                removeButton.addEventListener('click', function() {
                    removeLink(index);
                });
                
                savedLinksContainer.appendChild(linkItem);
            });
        }
        
        // ÁßªÈô§Â∑≤ÂÑ≤Â≠òÁöÑÈÄ£Áµê
        function removeLink(index) {
            savedLinks.splice(index, 1);
            renderSavedLinks();
            showNotification('ÈÄ£ÁµêÂ∑≤ÊàêÂäüÁßªÈô§');
        }
        
        // Ê∏ÖÈô§ÊâÄÊúâÂ∑≤ÂÑ≤Â≠òÁöÑÈÄ£Áµê
        function clearAllLinks() {
            if (savedLinks.length === 0) {
                showNotification('ÁõÆÂâçÊ≤íÊúâÂ∑≤ÂÑ≤Â≠òÁöÑÈÄ£Áµê', true);
                return;
            }
            
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂ∑≤ÂÑ≤Â≠òÁöÑÈÄ£ÁµêÂóéÔºü')) {
                savedLinks = [];
                renderSavedLinks();
                showNotification('ÊâÄÊúâÈÄ£ÁµêÂ∑≤Ê∏ÖÈô§');
            }
        }
        
        // <!-- STAGE 5: ÂåØÂá∫ËàáÂåØÂÖ•ÂäüËÉΩ -->
        
        // ÂåØÂá∫ JSON Ê™îÊ°à
        function exportJson(links, filename = 'wikimedia_links.json') {
            if (links.length === 0) {
                showNotification('Ê≤íÊúâÈÄ£ÁµêÂèØ‰æõÂåØÂá∫', true);
                return;
            }
            
            const dataStr = JSON.stringify(links, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showNotification('JSON Ê™îÊ°àÂ∑≤ÂåØÂá∫');
        }
        
        // ÂåØÂá∫ÊñáÂ≠óÊ™î
        function exportText(links, filename = 'wikimedia_links.txt') {
            if (links.length === 0) {
                showNotification('Ê≤íÊúâÈÄ£ÁµêÂèØ‰æõÂåØÂá∫', true);
                return;
            }
            
            // ‰æùÈóúÈçµÂ≠óÂàÜÁµÑ
            const groupedLinks = {};
            links.forEach(link => {
                const keyword = link.searchKeyword || 'Êú™ÂàÜÈ°û';
                if (!groupedLinks[keyword]) {
                    groupedLinks[keyword] = [];
                }
                groupedLinks[keyword].push(link);
            });
            
            let textContent = '# Wikimedia Commons ÁÖßÁâáÈÄ£Áµê\n\n';
            
            // ‰æùÈóúÈçµÂ≠óËº∏Âá∫
            Object.keys(groupedLinks).forEach(keyword => {
                textContent += `## ${keyword}\n\n`;
                groupedLinks[keyword].forEach((link, index) => {
                    textContent += `${index + 1}. ${link.title}\n`;
                    textContent += `   ÈÄ£Áµê: ${link.directUrl}\n\n`;
                });
            });
            
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showNotification('ÊñáÂ≠óÊ™îÂ∑≤ÂåØÂá∫');
        }
        
        // ÂåØÂá∫ HTML Ê™îÊ°à
        function exportHtml(links, filename = 'wikimedia_photos.html') {
            if (links.length === 0) {
                showNotification('Ê≤íÊúâÈÄ£ÁµêÂèØ‰æõÂåØÂá∫', true);
                return;
            }
            
            // ‰æùÈóúÈçµÂ≠óÂàÜÁµÑ
            const groupedLinks = {};
            links.forEach(link => {
                const keyword = link.searchKeyword || 'Êú™ÂàÜÈ°û';
                if (!groupedLinks[keyword]) {
                    groupedLinks[keyword] = [];
                }
                groupedLinks[keyword].push(link);
            });
            
            let html = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Commons ÁÖßÁâáÈõÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #34495e;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        h2 {
            color: #2c3e50;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .photo-item {
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .photo-info {
            padding: 15px;
        }
        
        .photo-info h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .photo-info p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .photo-info a {
            color: #3498db;
            text-decoration: none;
            font-size: 14px;
        }
        
        .photo-info a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 900px) {
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 600px) {
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .photo-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wikimedia Commons ÁÖßÁâáÈõÜ</h1>
            <p>‰ΩøÁî®„ÄåWikimedia Commons ÁÖßÁâáÈÄ£ÁµêÊî∂ÈõÜÂ∑•ÂÖ∑„ÄçÊî∂ÈõÜÁöÑÁÖßÁâáÈÄ£Áµê</p>
        </header>`;
            
            // ‰æùÈóúÈçµÂ≠óÁîüÊàê HTML ÂÖßÂÆπ
            Object.keys(groupedLinks).forEach(keyword => {
                html += `
        <section>
            <h2>${keyword}</h2>
            <div class="photo-grid">`;
                
                groupedLinks[keyword].forEach(link => {
                    html += `
                <div class="photo-item">
                    <a href="${link.directUrl}" target="_blank">
                        <img src="${link.directUrl}" alt="${link.title}" loading="lazy">
                    </a>
                    <div class="photo-info">
                        <h3>${link.title}</h3>
                        ${link.dateAdded ? `<p>Êî∂ÈõÜÊó•Êúü: ${new Date(link.dateAdded).toLocaleString()}</p>` : ''}
                        <p><a href="${link.directUrl}" target="_blank">Êü•ÁúãÂéüÂßãÁÖßÁâá</a></p>
                    </div>
                </div>`;
                });
                
                html += `
            </div>
        </section>`;
            });
            
            html += `
    </div>
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showNotification('HTML Ê™îÊ°àÂ∑≤ÂåØÂá∫');
        }
        
        // ÂåØÂÖ• JSON Ê™îÊ°à
        function importJsonFile() {
            const file = importFileInput.files[0];
            if (!file) {
                showNotification('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂåØÂÖ•ÁöÑ JSON Ê™îÊ°à', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedLinks = JSON.parse(event.target.result);
                    
                    if (Array.isArray(importedLinks) && importedLinks.length > 0) {
                        // Ê™¢Êü•Â∞éÂÖ•ÁöÑÊï∏ÊìöÊ†ºÂºèÊòØÂê¶Ê≠£Á¢∫
                        const isValidFormat = importedLinks.every(link => 
                            typeof link === 'object' && 
                            link.hasOwnProperty('title') && 
                            link.hasOwnProperty('directUrl')
                        );
                        
                        if (isValidFormat) {
                            // Á¢∫‰øùÊØèÂÄãÂåØÂÖ•ÁöÑÈÄ£ÁµêÈÉΩÊúâÁ∏ÆÂúñURL
                            importedLinks.forEach(link => {
                                if (!link.thumbUrl) {
                                    link.thumbUrl = createThumbUrl(link.directUrl);
                                }
                            });
                            
                            // Âêà‰ΩµÈÄ£ÁµêÔºåÈÅøÂÖçÈáçË§á
                            const newLinks = importedLinks.filter(importedLink => 
                                !savedLinks.some(savedLink => savedLink.directUrl === importedLink.directUrl)
                            );
                            
                            savedLinks = [...savedLinks, ...newLinks];
                            renderSavedLinks();
                            
                            if (newLinks.length > 0) {
                                showNotification(`ÊàêÂäüÂåØÂÖ• ${newLinks.length} ÂÄãÈÄ£Áµê`);
                            } else {
                                showNotification('ÊâÄÊúâÈÄ£ÁµêÂ∑≤Â≠òÂú®ÔºåÊú™Ê∑ªÂä†Êñ∞ÈÄ£Áµê');
                            }
                        } else {
                            showNotification('JSON Ê†ºÂºè‰∏çÊ≠£Á¢∫ÔºåË´ãÁ¢∫‰øùÊñá‰ª∂ÂåÖÂê´ÊúâÊïàÁöÑÈÄ£ÁµêÊï∏Êìö', true);
                        }
                    } else {
                        showNotification('JSON Ê™îÊ°à‰∏≠Ê≤íÊúâÊúâÊïàÁöÑÈÄ£ÁµêÊï∏Êìö', true);
                    }
                } catch (error) {
                    showNotification('ÁÑ°Ê≥ïËß£Êûê JSON Ê™îÊ°àÔºåË´ãÁ¢∫‰øùÊ™îÊ°àÊ†ºÂºèÊ≠£Á¢∫', true);
                    console.error('JSON Ëß£ÊûêÈåØË™§:', error);
                }
                
                // Ê∏ÖÈô§Ê™îÊ°àËº∏ÂÖ•Ôºå‰ª•‰æøÂÜçÊ¨°ÈÅ∏ÊìáÂêå‰∏ÄÂÄãÊ™îÊ°à
                importFileInput.value = '';
            };
            
            reader.onerror = function() {
                showNotification('ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§', true);
            };
            
            reader.readAsText(file);
        }
        
        // È°ØÁ§∫ÂåØÂá∫È†êË¶Ω
        function showExportPreview(type, links = savedLinks) {
            // ÂàáÊèõÂà∞ÂåØÂá∫Ê®ôÁ±§È†Å
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('[data-tab="export-tab"]').classList.add('active');
            document.getElementById('export-tab').classList.add('active');
            
            if (links.length === 0) {
                exportPreview.innerHTML = '<p>Ê≤íÊúâÈÄ£ÁµêÂèØ‰æõÈ†êË¶Ω</p>';
                return;
            }
            
            switch (type) {
                case 'json':
                    const jsonPreview = JSON.stringify(links.slice(0, 3), null, 2);
                    exportPreview.innerHTML = `<p>JSON Ê†ºÂºèÈ†êË¶Ω (ÂÉÖÈ°ØÁ§∫Ââç 3 ÂÄãÈ†ÖÁõÆ):</p><pre>${jsonPreview}${links.length > 3 ? '\n...' : ''}</pre>`;
                    break;
                    
                case 'text':
                    // ‰æùÈóúÈçµÂ≠óÂàÜÁµÑÈ†êË¶Ω
                    const groupedLinks = {};
                    links.slice(0, 5).forEach(link => {
                        const keyword = link.searchKeyword || 'Êú™ÂàÜÈ°û';
                        if (!groupedLinks[keyword]) {
                            groupedLinks[keyword] = [];
                        }
                        groupedLinks[keyword].push(link);
                    });
                    
                    let textPreview = '# Wikimedia Commons ÁÖßÁâáÈÄ£Áµê\n\n';
                    Object.keys(groupedLinks).forEach(keyword => {
                        textPreview += `## ${keyword}\n\n`;
                        groupedLinks[keyword].forEach((link, index) => {
                            textPreview += `${index + 1}. ${link.title}\n`;
                            textPreview += `   ÈÄ£Áµê: ${link.directUrl}\n\n`;
                        });
                    });
                    
                    if (links.length > 5) {
                        textPreview += '...\n';
                    }
                    
                    exportPreview.innerHTML = `<p>ÊñáÂ≠óÊ™îÈ†êË¶Ω (ÂÉÖÈ°ØÁ§∫Ââç 5 ÂÄãÈ†ÖÁõÆ):</p><pre>${textPreview}</pre>`;
                    break;
                    
                case 'html':
                    exportPreview.innerHTML = `<p>HTML Ê™îÊ°àÂ∑≤ÁîüÊàê„ÄÇHTML Ê™îÊ°àÂåÖÂê´‰∏ÄÂÄãÂÆåÊï¥ÁöÑÁ∂≤È†ÅÔºåÊåâÈóúÈçµÂ≠óÂàÜÈ°ûÈ°ØÁ§∫ÊâÄÊúâÁÖßÁâáÔºå‰∏¶ÂÖ∑ÊúâÈüøÊáâÂºèË®≠Ë®àÔºåÂèØ‰ª•Âú®‰ªª‰ΩïË®≠ÂÇô‰∏äÊ≠£Â∏∏Êü•Áúã„ÄÇ</p>`;
                    break;
            }
        }
        
        // <!-- STAGE 6: ÊâπÊ¨°Êü•Ë©¢ÂäüËÉΩ -->
        
        // ÂåØÂÖ•ÊâπÊ¨°ÈóúÈçµÂ≠ó
        function importBatchKeywords() {
            const file = batchKeywordsFileInput.files[0];
            if (!file) {
                showNotification('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂåØÂÖ•ÁöÑÈóúÈçµÂ≠óÊ™îÊ°à', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    
                    // ÂàÜÂâ≤ÂÖßÂÆπÁÇ∫Ë°å
                    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                    
                    if (lines.length > 0) {
                        batchKeywordsTextarea.value = lines.join('\n');
                        showNotification(`Â∑≤ÂåØÂÖ• ${lines.length} ÂÄãÈóúÈçµÂ≠ó`);
                    } else {
                        showNotification('Ê™îÊ°à‰∏≠Ê≤íÊúâÊúâÊïàÁöÑÈóúÈçµÂ≠ó', true);
                    }
                } catch (error) {
                    showNotification('ÁÑ°Ê≥ïËß£ÊûêÊ™îÊ°àÂÖßÂÆπÔºåË´ãÁ¢∫‰øùÊ™îÊ°àÊ†ºÂºèÊ≠£Á¢∫', true);
                    console.error('Ê™îÊ°àËß£ÊûêÈåØË™§:', error);
                }
                
                // Ê∏ÖÈô§Ê™îÊ°àËº∏ÂÖ•Ôºå‰ª•‰æøÂÜçÊ¨°ÈÅ∏ÊìáÂêå‰∏ÄÂÄãÊ™îÊ°à
                batchKeywordsFileInput.value = '';
            };
            
            reader.onerror = function() {
                showNotification('ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§', true);
            };
            
            reader.readAsText(file);
        }
        
        // ÈñãÂßãÊâπÊ¨°Êü•Ë©¢
        async function startBatchQuery() {
            const keywordsText = batchKeywordsTextarea.value.trim();
            if (keywordsText === '') {
                showNotification('Ë´ãËº∏ÂÖ•Ëá≥Â∞ë‰∏ÄÂÄãÊü•Ë©¢ÈóúÈçµÂ≠ó', true);
                return;
            }
            
            // Ëß£ÊûêÈóúÈçµÂ≠óÂàóË°®
            const keywords = keywordsText.split(/\r?\n/).filter(line => line.trim() !== '');
            
            if (keywords.length === 0) {
                showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊü•Ë©¢ÈóúÈçµÂ≠ó', true);
                return;
            }
            
            // Áç≤ÂèñÊØèÂÄãÈóúÈçµÂ≠óÁöÑÁµêÊûúÊï∏Èáè
            const batchLimit = parseInt(batchLimitInput.value) || 5;
            
            // È°ØÁ§∫ÁãÄÊÖãÂçÄÂüü
            batchStatus.style.display = 'block';
            batchStatusText.textContent = `Ê∫ñÂÇôÊü•Ë©¢ ${keywords.length} ÂÄãÈóúÈçµÂ≠ó...`;
            progressBar.style.width = '0%';
            
            // Ê∏ÖÁ©∫ÂÖàÂâçÁöÑÊâπÊ¨°ÁµêÊûú
            batchQueryResults = [];
            batchResults.innerHTML = '';
            batchResults.style.display = 'none';
            
            // ‰æùÂ∫èÊü•Ë©¢ÊØèÂÄãÈóúÈçµÂ≠ó
            for (let i = 0; i < keywords.length; i++) {
                const keyword = keywords[i].trim();
                if (keyword === '') continue;
                
                batchStatusText.textContent = `Ê≠£Âú®Êü•Ë©¢ "${keyword}" (${i+1}/${keywords.length})...`;
                progressBar.style.width = `${Math.round((i / keywords.length) * 100)}%`;
                
                try {
                    // Âü∑Ë°åÊü•Ë©¢
                    const results = await batchQueryKeyword(keyword, batchLimit);
                    
                    // È°ØÁ§∫ÁµêÊûú
                    renderBatchResult(keyword, results);
                    
                    // Êö´ÂÅú‰∏Ä‰∏ãÔºåÈÅøÂÖçÂ∞ç API ÁôºÈÄÅÈÅéÂ§öË´ãÊ±Ç
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`ÊâπÊ¨°Êü•Ë©¢ "${keyword}" ÊôÇÁôºÁîüÈåØË™§:`, error);
                    renderBatchResult(keyword, [], true);
                }
            }
            
            // ÂÆåÊàêÊâÄÊúâÊü•Ë©¢
            batchStatusText.textContent = `ÂÆåÊàêÊâÄÊúâ ${keywords.length} ÂÄãÈóúÈçµÂ≠óÁöÑÊü•Ë©¢`;
            progressBar.style.width = '100%';
            
            if (batchQueryResults.length > 0) {
                batchResults.style.display = 'block';
                showNotification(`ÊâπÊ¨°Êü•Ë©¢ÂÆåÊàêÔºåÂÖ±Áç≤Âèñ ${batchQueryResults.length} ÂÄãÈÄ£Áµê`);
            } else {
                showNotification('ÊâπÊ¨°Êü•Ë©¢ÂÆåÊàêÔºå‰ΩÜÊú™ÊâæÂà∞‰ªª‰ΩïÊúâÊïàÈÄ£Áµê', true);
            }
        }
        
        // ÊâπÊ¨°Êü•Ë©¢ÂñÆÂÄãÈóúÈçµÂ≠ó
        async function batchQueryKeyword(keyword, limit) {
            return new Promise((resolve, reject) => {
                // ÊßãÂª∫ Wikimedia Commons API Ë´ãÊ±Ç‰æÜÊêúÂ∞ãÁÖßÁâá
                const searchApiUrl = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(keyword)}+filetype:bitmap|drawing&srnamespace=6&format=json&origin=*&srlimit=${limit * 2}`; // Â§öÊü•Ë©¢‰∏Ä‰∫õÔºåÂõ†ÁÇ∫ÂèØËÉΩÊúâ‰∫õÁÑ°Ê≥ïÁç≤ÂèñÁõ¥Êé•ÈÄ£Áµê
                
                fetch(searchApiUrl)
                    .then(response => response.json())
                    .then(async data => {
                        if (!data.query || !data.query.search || data.query.search.length === 0) {
                            resolve([]);
                            return;
                        }
                        
                        // Áç≤ÂèñÊêúÂ∞ãÁµêÊûú
                        const searchResults = data.query.search;
                        const processedResults = [];
                        
                        // ËôïÁêÜÊêúÂ∞ãÁµêÊûúÔºåÁõ¥Âà∞ÈÅîÂà∞ÊåáÂÆöÊï∏ÈáèÊàñËôïÁêÜÂÆåÊâÄÊúâÁµêÊûú
                        let index = 0;
                        while (processedResults.length < limit && index < searchResults.length) {
                            const result = searchResults[index];
                            
                            // ÂæûÁµêÊûúÊ®ôÈ°å‰∏≠ÂèñÂæóÊ™îÊ°àÂêçÁ®±
                            const fileName = result.title.replace('File:', '');
                            
                            // ÊßãÂª∫Ë©≥ÊÉÖÈ†ÅÈù¢ URL
                            const detailPageUrl = `https://commons.wikimedia.org/wiki/File:${encodeURIComponent(fileName)}`;
                            
                            try {
                                // Áç≤ÂèñÊ™îÊ°àË≥áË®äÂíåÈÄ£Áµê
                                const fileInfo = await fetchFileInfo(fileName, detailPageUrl);
                                
                                // Âè™ÊúâÂú®ÊàêÂäüÁç≤ÂèñÁõ¥Êé•ÈÄ£ÁµêÊôÇÊâçÊ∑ªÂä†Âà∞ÁµêÊûú‰∏≠
                                if (fileInfo.directUrl) {
                                    processedResults.push({
                                        title: fileName,
                                        directUrl: fileInfo.directUrl,
                                        thumbUrl: fileInfo.thumbUrl,
                                        searchKeyword: keyword,
                                        dateAdded: new Date().toISOString()
                                    });
                                    
                                    // ÂêåÊôÇÊ∑ªÂä†Âà∞ÂÖ®Â±ÄÊâπÊ¨°ÁµêÊûú‰∏≠
                                    batchQueryResults.push({
                                        title: fileName,
                                        directUrl: fileInfo.directUrl,
                                        thumbUrl: fileInfo.thumbUrl,
                                        searchKeyword: keyword,
                                        dateAdded: new Date().toISOString()
                                    });
                                }
                            } catch (error) {
                                console.error(`ÊâπÊ¨°Êü•Ë©¢‰∏≠Áç≤ÂèñÊ™îÊ°àË≥áË®äÈåØË™§ (${fileName}):`, error);
                            }
                            
                            // Â¢ûÂä†Á¥¢Âºï‰∏¶Êö´ÂÅú‰∏Ä‰∏ã
                            index++;
                            if (index < searchResults.length) {
                                await new Promise(r => setTimeout(r, 300));
                            }
                        }
                        
                        resolve(processedResults);
                    })
                    .catch(error => {
                        console.error('ÊâπÊ¨°ÊêúÂ∞ãÈåØË™§:', error);
                        reject(error);
                    });
            });
        }
        
        // Ê∏≤ÊüìÊâπÊ¨°Êü•Ë©¢ÁµêÊûú
        function renderBatchResult(keyword, results, hasError = false) {
            const resultItem = document.createElement('div');
            resultItem.className = 'batch-result-item';
            
            let content = `<div class="batch-keyword">${keyword}</div>`;
            
            if (hasError) {
                content += `<div style="color: #e74c3c;">Êü•Ë©¢ÊôÇÁôºÁîüÈåØË™§</div>`;
            } else if (results.length === 0) {
                content += `<div>Êú™ÊâæÂà∞Áõ∏ÈóúÁÖßÁâá</div>`;
            } else {
                content += `<div>ÊâæÂà∞ ${results.length} ÂÄãÁÖßÁâáÈÄ£Áµê</div>`;
                content += `<div class="batch-links">`;
                
                results.forEach(result => {
                    // Ê∑ªÂä†Á∏ÆÂúñÈ°ØÁ§∫
                    const thumbUrl = result.thumbUrl || createThumbUrl(result.directUrl);
                    content += `
                        <div class="batch-link" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <img src="${thumbUrl}" alt="${result.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.src='https://via.placeholder.com/50?text=ÂúñÁâá'">
                            <span class="batch-link-title">${result.title}</span>
                            <span class="batch-link-url">${result.directUrl}</span>
                        </div>
                    `;
                });
                
                content += `</div>`;
            }
            
            resultItem.innerHTML = content;
            batchResults.appendChild(resultItem);
        }
        
        // ÂÑ≤Â≠òÊâπÊ¨°Êü•Ë©¢ÁµêÊûú
        function saveBatchResults() {
            if (batchQueryResults.length === 0) {
                showNotification('Ê≤íÊúâÊâπÊ¨°Êü•Ë©¢ÁµêÊûúÂèØ‰æõÂÑ≤Â≠ò', true);
                return;
            }
            
            // Âêà‰ΩµÈÄ£ÁµêÔºåÈÅøÂÖçÈáçË§á
            const newLinks = batchQueryResults.filter(batchLink => 
                !savedLinks.some(savedLink => savedLink.directUrl === batchLink.directUrl)
            );
            
            if (newLinks.length > 0) {
                savedLinks = [...savedLinks, ...newLinks];
                renderSavedLinks();
                showNotification(`Â∑≤ÂÑ≤Â≠ò ${newLinks.length} ÂÄãÊâπÊ¨°Êü•Ë©¢ÁµêÊûú`);
            } else {
                showNotification('ÊâÄÊúâÈÄ£ÁµêÂ∑≤Â≠òÂú®ÔºåÊú™Ê∑ªÂä†Êñ∞ÈÄ£Áµê');
            }
        }
        
        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'notification error show' : 'notification show';
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }
        
        // <!-- STAGE 7: ÂÆåÊï¥ÂäüËÉΩÊï¥ÂêàËàáÂàùÂßãÂåñ -->
        
        // ÂàùÂßãÂåñÈ†ÅÈù¢
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>